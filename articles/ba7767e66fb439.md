---
title: "PrismaDataProxyãŒé…ã„ã‚’è§£æ±ºã™ã‚‹"
emoji: "ğŸ”®"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prism","cloudrun","vercel","graphql"]
published: false
---

## æ¦‚è¦

PrismaDataProxyãŒé…ã„ã®ã§ã€ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è‡ªä½œã—ã¦è§£æ±ºã—ã¾ã—ãŸã€ã¨ã„ã†ãŠè©±ã§ã™ã€‚

### PrismaDataProxy ã¨ã¯

Prisma.ioãŒæä¾›ã™ã‚‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç®¡ç†ã¨ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã®ãŸã‚ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒã§ã™ã€‚
Cloudflare Workersã‚„Vecel Edge Functionãªã©ã¯ã€TCPæ¥ç¶šã«åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ãƒã‚¤ãƒ†ã‚£ãƒ–æ¥ç¶šãŒã§ãã¾ã›ã‚“ã€‚  
PrismaDataProxyãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®æ¥ç¶šã®é–“ã«å…¥ã‚Šã€Workerã‹ã‚‰ã¯HTTPæ¥ç¶šã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ä»®æƒ³æ¥ç¶šã‚’å®Ÿç¾ã—ã¾ã™ã€‚

![](/images/pdp-overview.png)

ä»¥é™ã€é•·ã„ã®ã§PrismaDataProxyã®ã“ã¨ã‚’**PDP**ã¨è¨˜è¼‰ã—ã¾ã™ã€‚

### PrismaDataProxy ã®å¼±ç‚¹

PDPã¯ https://cloud.prisma.io/ ã‹ã‚‰ã€Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§æ§‹ç¯‰ãŒå¯èƒ½ã§ã™ã€‚  
ã—ã‹ã—ã€2022/06/19ç¾åœ¨ã€é¸æŠã§ãã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€ãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ã¨ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆã®2æ‹ ç‚¹ã®ã¿ã§ã™ã€‚

![](/images/pdp-regions.png)

ãã—ã¦ã€ã‚µãƒ¼ãƒãƒ¬ã‚¹ã§ã®ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã¨ãªã£ã¦ãŠã‚Šã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ³ãƒã‚¤ã«ã‚ˆã‚‹ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®å½±éŸ¿ã‚‚å—ã‘ã¾ã™ã€‚

PDPã®åˆ©ç”¨ã‚±ãƒ¼ã‚¹ã¯Cloudflare Workersãªã©ã®ã‚¨ãƒƒã‚¸ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ©ç”¨ãŒå¤§åŠã§ã™ãŒã€ãã“ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒå¤§ãããªã‚‹ã¨ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ¡ãƒªãƒƒãƒˆã¯è–„ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚  

æ‰‹å…ƒã®è¨ˆæ¸¬ã§ã¯ã€ãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é¸æŠã—ã€åŒã˜ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«Planetscaleã‚’æ§‹ç¯‰ã—ã¦æ¥ç¶šã—ãŸéš›ã«ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ³ãƒã‚¤æ™‚ã§ã¯**2.6så‰å¾Œ**ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ³ãƒã‚¤ãªã—ã§ã‚‚**600mså‰å¾Œ**ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’è¦³æ¸¬ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã§ã¯ã‚µãƒ¼ãƒ“ã‚¹ã«æŠ•å…¥ã™ã‚‹ã“ã¨ã¯éå¸¸ã«é›£ã—ã„ã§ã™ãŒã€Prismaã®å¼·åŠ›ãªå‹ç”Ÿæˆæ©Ÿèƒ½ã®æ©æµã‚’å—ã‘ãŸã‹ã£ãŸãŸã‚ã€ãªã‚“ã¨ã‹PDPã‚’æ—¥æœ¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã—ã€æ›´ã«ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ³ãƒã‚¤ã®å½±éŸ¿ã®å°ã•ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§æ§‹ç¯‰ã§ããªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

## Prisma Clientã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€

ã¾ãšã€PDPã®ã‚µãƒ¼ãƒã‚½ãƒ¼ã‚¹ãŒå…¬é–‹ã•ã‚Œã¦ã„ãªã„ã‹ã¨æ€ã„æ¢ã—ã¦ã¿ã¾ã—ãŸãŒã€æ®‹å¿µãªãŒã‚‰å…¬é–‹ã¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚  
ãã“ã§ã€Prisma Clientå´ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ã€PDPã¨ã©ã®ã‚ˆã†ãªé€šä¿¡ã‚’è¡Œã£ã¦ã„ã‚‹ã‹ã‚’è¦‹ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãªPDPã®å†…éƒ¨ã‚’è§£ãæ˜ã‹ã›ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

Prismaã®Clientã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ãƒ¼ãƒ‰(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã¨ãƒã‚¤ãƒŠãƒªãƒ¢ãƒ¼ãƒ‰ã€ãã—ã¦DataProxyãƒ¢ãƒ¼ãƒ‰ã®3ã¤ã«ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãŒåˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚
3ã¤ã‚ã®DataProxyãƒ¢ãƒ¼ãƒ‰ã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒã€PDPã¨é€šä¿¡ã‚’è¡Œã†ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

https://github.com/prisma/prisma/blob/main/packages/engine-core/src/data-proxy/DataProxyEngine.ts#L132-L145

`requestInternal`ã®å®Ÿè£…ã‚’ã¿ã‚‹ã¨ã€GraphQLã½ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’PDPã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æŠ•ã’ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚  

å®Ÿéš›ã«ã€ã‚½ãƒ¼ã‚¹ã«`console.log`ã‚’ä»•è¾¼ã‚“ã§bodyã‚’é™¤ã„ã¦ã¿ã‚‹ã¨ã€`db.link.findMany({ select: { id: true, url: true }, where: { id: 1 } })`ã¨ã„ã†ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ãŸã¨ãã«ã€ã“ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªãŒæŠ•ã’ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
```graphql
query query {
  findManyLink(where: { id: 1 }) {
    id
    url
  }
}
```


ä¾‹å¤–ã¯ã‚ã‚Šã¾ã™ãŒã€ãŠãŠã‚ˆãã“ã®ã‚ˆã†ãªæ³•å‰‡ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
```
[query|mutation] query {
  [ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å][ãƒ¢ãƒ‡ãƒ«å]([selectä»¥å¤–ã®å¼•æ•°(where,take,skip,etc...)]) {
    selectã§ç¤ºã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¥ã‚Œå­ã«ãªã‚‹
  }
}
```

create,update,deleteç³»ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯`mudation`ã§ã€‚

ã“ã®æ³•å‰‡ã«å¾“ã£ãŸGraphQLã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚Œã°ã€PDPã‚’ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã—ãŸã‚‚ã®ã«ä»£æ›¿ã§ããã†ã§ã™ã€‚

## PDPç”¨ã®GraphQLã‚µãƒ¼ãƒã‚’ä»®çµ„ã¿ã™ã‚‹

å®Ÿéš›ã«å‰è¿°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒã¨ãƒªã‚¾ãƒ«ãƒã‚’å®šç¾©ã—ã€Apolloã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã—ãŸã¨ãã«æ­£ã—ãã€Prisma ClientãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ­£ã—ãè§£é‡ˆã§ãã‚‹ã‹å®Ÿé¨“ã—ã¦ã¿ã¾ã™ã€‚

```graphql
scalar DateTime
scalar Any

type Link {
  id: String!
  createdAt: DateTime!
  updatedAt: DateTime!
  url: String!
  shortUrl: String!
  userId: String
  User: User
}

type User {
  id: String!
  createdAt: DateTime!
  updatedAt: DateTime!
  name:      String!
  email:     String!
  links:     [Link!]!
}

type Query {
  findManyLink(where: Any): [Link!]!
}
```

```ts
const resolver = {
  Link: {
    User: ({ id }, args) => {
      return db.link.findUnique({ where: { id } }).User(args)
    }
  },
  Query: {
    findManyLink: (_, args) => {
      return db.link.findMany(args)
    }
  }
}
```