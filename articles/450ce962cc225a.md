---
title: "[Next.js] ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³"
emoji: "ğŸ§±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs","typescript","react"]
published: false
---

## ã¯ã˜ã‚ã«

Next.js ã§ MPA ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã¨ã€ãƒšãƒ¼ã‚¸å˜ä½ã§ã‚¢ã‚¯ã‚¢ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡Œã„ãŸã„ã¨ã„ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã“ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯ã€ãƒšãƒ¼ã‚¸ã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªæ¡ä»¶ã‚’å®šç¾©ã—ãŸã‚Šã€ãƒ«ãƒ¼ãƒ«ã«ããã‚ãªã„ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¥ã®ãƒšãƒ¼ã‚¸ã«è»¢é€ã•ã›ã‚‹ãªã©ã®å‡¦ç†ã‚’æ„å‘³ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶å‘ã‘ã®ãƒšãƒ¼ã‚¸ã¨ã€ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶å‘ã‘ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æŒã¤ã‚±ãƒ¼ã‚¹ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚
- ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶å‘ã‘ãƒšãƒ¼ã‚¸ã¯èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒã‚¤ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ»ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒšãƒ¼ã‚¸ã‚‚å­˜åœ¨ã™ã‚‹ãŒã€ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã‚ã‚Œã°ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
    - ãŸã ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ ã¯èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

ä»Šå›ã¯ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ä¸Šã§ã®ã€ã„ãã¤ã‹ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è€ƒãˆã¾ã™ã€‚

:::message
å€‹äººçš„ã«ã¯ä¸­è¦æ¨¡ä»¥ä¸Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãƒ‘ã‚¿ãƒ¼ãƒ³3ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
:::

## ãƒ‘ã‚¿ãƒ¼ãƒ³1: å„ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒãƒ³ãƒˆå†…ã§åˆ¶å¾¡ã™ã‚‹

ã¾ãšã¯å„ãƒšãƒ¼ã‚¸ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡Œã†ã‚±ãƒ¼ã‚¹ã§ã™ã€‚
ä¾¿å®œä¸Š `isLoggedIn()` ã®å®Ÿè£…ã¯çœç•¥ã—ã¾ã™ã€‚

```tsx
// pages/mypage.tsx
const Mypage: VFX = (props) => {
  const router = useRouter()
  if (!isLoggedIn()) router.replace('/signin') // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸è»¢é€

  return <div>...</div>
}

export default Mypage
```

```tsx
// pages/signin.tsx
const Signin: VFX = (props) => {
  const router = useRouter()
  if (isLoggedIn()) router.replace('/mypage') // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã‚ã‚Œã°ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸è»¢é€

  return <div>...</div>
}

export default Signin
```

ã“ã®ã‚±ãƒ¼ã‚¹ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚ãŠãã‚‰ãèª°ã‚‚ãŒä¸€ç•ªæœ€åˆã«æ€ã„ã¤ããƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
ãƒšãƒ¼ã‚¸æ•°ãŒå°‘ãªã„ã†ã¡ã¯ã“ã‚Œã§å•é¡Œãªã„ã®ã§ã™ãŒã€ãƒšãƒ¼ã‚¸æ•°ãŒå¢—ãˆã¦ãã‚‹ã¨ç ´ç¶»ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã€`/mypage/a` `/mypage/b` `/mypage/c` ã®ã‚ˆã†ã«è¤‡æ•°ãƒšãƒ¼ã‚¸ã‚ã‚‹å ´åˆã‚„ã€æ–°ã—ããƒšãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹å ´åˆã«ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¨˜è¿°ãŒæ¼ã‚Œã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

:::message
- **Pros**
   - ã‚·ãƒ³ãƒ—ãƒ«
   - ä»–ãƒšãƒ¼ã‚¸ã®åˆ¶å¾¡æƒ…å ±ã‚’ä¿ã¤å¿…è¦ãŒãªã„ã®ã§ã€é–¢å¿ƒåˆ†é›¢ãŒè¡Œãˆã¦ã„ã‚‹
- **Cons**
   - è¨­å®šã—å¿˜ã‚ŒãŒèµ·ã“ã‚Šå¾—ã‚‹
:::

## ãƒ‘ã‚¿ãƒ¼ãƒ³2: `_app.tsx` ã§é›†ä¸­ç®¡ç†ã™ã‚‹

ç¶šã„ã¦ã€ãƒšãƒ¼ã‚¸ã®å…±é€šã‚³ãƒ³ãƒãƒãƒ³ãƒˆã§ã‚ã‚‹ `_app.tsx` ã§å®Œçµã•ã›ã‚‹ã•ã›ã‚‹ã‚±ãƒ¼ã‚¹ã‚’è€ƒãˆã¾ã™ã€‚ 

```tsx
// pages/_app.tsx

const useAccessControll = () => {
  const router = useRouter()
  useEffect(() => {
    if (/^\/mypage/.test(router.asPath) && !isLoggedIn())
      router.replace('/signin')
    if (/^\/(signin|signup)/.test(router.asPath) && isLoggedIn())
      router.replace('/mypge')
  }, [router]) 
}

const App: VFX<AppProps> = ({ Component, pageProps }) => {
  useAccessControll()
  return <Component {...pageProps} />
}

export default App
```

ã“ã®ã‚ˆã†ã«ä¸€ç®‡æ‰€ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚Œã°ã€ãƒ«ãƒ¼ãƒ«ã®è¦‹é€šã—ãŒã‚ˆãç®¡ç†ã‚‚ã—ã‚„ã™ã„ã§ã™ã€‚
ã—ã‹ã—ã€ãƒšãƒ¼ã‚¸æ•°ã®å¢—åŠ ã‚„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¢—åŠ ã«ã‚ˆã‚Šã€å‡¦ç†ãŒè‚¥å¤§åŒ–ã—ã‚„ã™ãã€ã²ã„ã¦ã¯ `_app` ã®ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãããªã£ã¦ã—ã¾ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã‚’æã­ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚

:::message
- **Pros**
   - ãƒ«ãƒ¼ãƒ«ã®è¦‹é€šã—ãŒã‚ˆãç®¡ç†ã—ã‚„ã™ã„
- **Cons**
   - é–¢å¿ƒåˆ†é›¢ãŒè¡Œãˆã¦ãŠã‚‰ãšã€æœ€çµ‚çš„ã«`_app`ã®ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºå¢—åŠ ã«ç¹‹ãŒã‚Šã‚„ã™ã„
:::

## ãƒ‘ã‚¿ãƒ¼ãƒ³3: getAccessControl

ãƒ‘ã‚¿ãƒ¼ãƒ³1ã¨2ãã‚Œãã‚Œã®æ¬ ç‚¹ã‚’è£œã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ææ¡ˆã—ã¾ã™ã€‚

```ts
// index.d.ts
type AccessControlType = 'replace' | 'push';
type AccessControlFallback = { type: AccessControlType; destination: string }
type GetAccessControl = (
  user: User
) =>
  | null
  | AccessControlFallback
  | Promise<undefined | AccessControlFallback>
type WithGetAccessControl<P> = P & {
  getAccessControl?: GetAccessControl
}
```

```tsx
// pages/mypage.tsx
const Mypage: WithGetAccessControl<VFX> = (props) => {
  return <div>...</div>
}

Mypage.getAccessControl = () => {
  return !isLoggedIn() ? { type: 'replace', destination: '/signin' } : null
}

export default Mypage
```

```tsx
// pages/signin.tsx
const Signin: WithGetAccessControl<VFX> = (props) => {
  return <div>...</div>
}

Signin.getAccessControl = () => {
  return isLoggedIn() ? { type: 'replace', destination: '/mypage' } : null
}

export default Signin
```

```tsx
// pages/_app.tsx
const useAccessControll = (getAccessControll: GetAccessControl) => {
  const router = useRouter()
  useEffect(() => {
    const controll = async () => {
      const accessControl = await getAccessControll()
      if (!accessControl) return
      router[accessControl.type](accessControl.destination)
    }
    controll()
  }, [router]) 
}

const accessControl = () => {
  throw new Error('getAccessControl ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
};

type Props = AppProps & {
  Component: {
    getAccessControl?: GetAccessControl
  }
}

const App: VFX<Props> = ({ Component, pageProps }) => {
  const { getAccessControl = accessControl } = Component
  useAccessControll(getAccessControl)
  return <Component {...pageProps} />
}

export default App
```

å„ãƒšãƒ¼ã‚¸ã§ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒãƒ³ãƒˆã«å¯¾ã—ã¦ã€`getAccessControl` ã¨ã„ã†é–¢æ•°ã‚’å®šç¾©ã—ã¦æ³¨å…¥ã—ã¾ã™ã€‚ 
`_app` ã§ã€ãã® `getAccessControl` ã‚’å–ã‚Šå‡ºã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«ã‚’å¾—ã¦ã€ãã‚Œã«å¾“ã£ã¦å‡¦ç†ã‚’ã™ã‚‹ã¨ã„ã†æµã‚Œã§ã™ã€‚
ãã†ã™ã‚‹ã“ã¨ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®åˆ¶å¾¡æ§‹æ–‡ãã®ã‚‚ã®ã¯ã€å„ãƒšãƒ¼ã‚¸ã«é–‰ã˜ã‚‹ã“ã¨ã«ãªã‚‹ãŸã‚ã€é–¢å¿ƒåˆ†é›¢ãŒè¡Œãˆã¦ãŠã‚Šã€å‡¦ç†ã®è¤‡é›‘åŒ–ã«ä¼´ã† `_app` ã®ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºå¢—åŠ ã‚‚é˜²æ­¢ã§ãã¾ã™ã€‚
å„ãƒšãƒ¼ã‚¸ã§ã®å®šç¾©å¿˜ã‚Œã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã«ã€ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã ã‘ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”¨ã®é–¢æ•°ã‚’å®šç¾©ã™ã‚Œã°ã€ãƒ‘ã‚¿ãƒ¼ãƒ³1ã®æ¬ ç‚¹ã‚’è£œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ã€ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒãƒãƒ³ãƒˆã«å¯¾ã—ã¦ã€å¤–éƒ¨ã‹ã‚‰é–¢æ•°ã‚’ç”Ÿã‚„ã™ã¨ã„ã†è¨˜è¿°ã«é–¢ã—ã¦ã€ä¸€è¦‹ãƒ«ãƒ¼ãƒ«ã‹ã‚‰å¤–ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã‚‚æ€ãˆã¾ã™ãŒã€å®Ÿã¯ Next.js ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é–¢ã™ã‚‹å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚åŒã˜ã‚ˆã†ãªæ–¹æ³•ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚
https://nextjs.org/docs/basic-features/layouts#per-page-layouts

## ç•ªå¤–ç·¨: ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§åˆ¶å¾¡ã™ã‚‹

ã“ã“ã¾ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§åˆ¶å¾¡ã™ã‚‹æ–¹æ³•ã‚’è¨˜è¿°ã—ã¾ã—ãŸãŒã€æœ¬æ¥ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ã‚ˆã†ãªã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªãƒšãƒ¼ã‚¸ã¯ã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã»ã†ãŒå®‰å…¨ã§ã™ã€‚
`getServerSide` ã‚„ `next.config.js` ã® `rewrites`, `redirects` ãƒ«ãƒ¼ãƒ«ãªã©ã§åˆ¶å¾¡ã™ã‚‹ã“ã¨ã‚‚è¦–é‡ã«å…¥ã‚Œã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

ã‚‚ã—ã€ç‰¹å®šãƒ‘ã‚¹ã«å¯¾ã—ã¦ã®éèªè¨¼ãƒ¦ãƒ¼ã‚¶ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ãƒ»ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã ã‘ã§ã‚ˆã„ã®ã§ã‚ã‚Œã°ã€ã“ã¡ã‚‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ãŠã™ã™ã‚ã§ã™ã€‚
firebase auth, cognito, auth0 ãªã©ã®èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ã ã‘ã§ãªãIPãƒ¬ãƒ³ã‚¸ã§ã®åˆ¶å¾¡ã‚‚å¯èƒ½ã§ã€ãƒ«ãƒ¼ãƒ«ã®è¨˜è¿°ã¯ `next.config.js` ã§è¡Œã†ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®è¨˜è¿°ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
https://github.com/aiji42/next-fortress

åˆ¶å¾¡æ–¹æ³•ã« firebase ã‚’ä½¿ã†å ´åˆã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
```js
// next.config.js
const withFortress = require('next-fortress')({
  forts: [
    {
      inspectBy: 'firebase',
      mode: 'redirect',
      source: '/mypage/:path*',
      destination: '/signin',
    }
  ],
  firebase: {
    clientEmail: 'your client emai',
    projectId: 'your project id',
    privateKey: 'your private key'
  }
})
```

```tsx
// pages/_app.tsx
import { useFortressWithFirebase } from 'next-fortress/build/client'
import firebase from 'firebase/app'

function MyApp({ Component, pageProps }: AppProps) {
  useFortressWithFirebase(firebase)
  return <Component {...pageProps} />
}
```
