---
title: "バリデーションメッセージをいちいち定義したくない"
emoji: "💭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

フォームを作成する場合、最近は個人的には react-hook-form と zod を使用して実装することが多い。

こんな感じで、簡単にスキーマの定義とバリデーションの設定ができて、フォームの各フィールドと組み合わせることが可能である。

```tsx
const schema = z.object({
  username: z
    .string()
    .min(3, "3文字以上で入力してください")
    .max(10, "10文字以上で入力してください"),
  email: z.string().email("メールアドレスの形式で入力してください"),
  favoriteNumber: z
    .number()
    .max(10, "10以下の数字を入力してください")
    .min(1, "1以上の数字を入力してください"),
});

const Form = () => {
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm({
    resolver: zodResolver(schema),
  });
  
  return (
    <form onSubmit={handleSubmit(console.log)}>
      <FormControl isInvalid={!!errors.username} mb={4}>
        <FormLabel htmlFor="username">ユーザ名</FormLabel>
        <Input id="username" {...register("username")} />
        <FormErrorMessage>{(errors.username?.message ?? "")}</FormErrorMessage>
      </FormControl>
      <FormControl isInvalid={!!errors.email} mb={4}>
        <FormLabel htmlFor="email">メールアドレス</FormLabel>
        <Input id="email" {...register("email")} />
        <FormErrorMessage>{(errors.email?.message ?? "")}</FormErrorMessage>
      </FormControl>
      <FormControl isInvalid={!!errors.favoriteNumber} mb={4}>
        <FormLabel htmlFor="favoriteNumber">好きな数字</FormLabel>
        <Input id="favoriteNumber" {...register("favoriteNumber", { setValueAs: Number })} />
        <FormErrorMessage>{(errors.favoriteNumber?.message ?? "")}</FormErrorMessage>
      </FormControl>
      <Button mt={4} colorScheme="teal" isLoading={isSubmitting} type="submit">送信</Button>
    </form>
  )
}
```

![](/images/zod-form.png)

この上なく便利な組み合わせだが、唯一の不満はバリデーションメッセージを定義しないといけないところだ。  
こんな感じで一つ一つの条件に対して、メッセージを割り当てる必要がある。  
また「3文字」とか「10以下」とか、条件のパラメータをメッセージにベタで含めないといけないのも、若干もやっとするところ。

```ts
const schema = z.object({
  username: z
    .string()
    .min(3, "3文字以上で入力してください")
    .max(10, "10文字以上で入力してください"),
  email: z.string().email("メールアドレスの形式で入力してください"),
  favoriteNumber: z
    .number()
    .max(10, "10以下の数字を入力してください")
    .min(1, "1以上の数字を入力してください"),
});
```

この定義を省略する事もできるが、英語のデフォルトメッセージが表示されてしまい、日本人に対してのサービス提供を前提とするのであれば、このひと手間を許容しなければならない。

![](/images/zod-form-default.png)

また、実際のサービスではもっとフィールドの数が多かったり、サービスの中でいくつかのスキーマを管理しなければならないこともあるので、複雑である上に表記ゆれの問題も考慮しなければならなくなる。

Railsでサービスを作っていた頃はこういったエラーメッセージをi18nの辞書yamlで管理していた経験のせいか、個人的にこういったメッセージを直接コード内に書くのは好きではない。
なので、i18nの仕組みを使っていい感じにできないかと探してみたが、残念ながらzodのi18nプロジェクトがなかったので自分で作った。

---

![](https://raw.githubusercontent.com/aiji42/zod-i18n/main/images/hero.png)

https://github.com/aiji42/zod-i18n

内部的には、zodのエラーマッピングをi18nextで解釈可能なフラットなキーに変換して、翻訳ファイルからメッセージを引当るという簡単な仕組み。


これを使用すると、エラーメッセージの定義を省くことができる。
```tsx
import i18next from 'i18next'
import { z } from 'zod'
import { zodI18nMap } from "zod-i18n-map"
import translation from 'zod-i18n-map/locales/ja/zod.json'

i18next.init({
  lng: 'ja',
  resources: {
    ja: { zod: translation },
  },
});
z.setErrorMap(zodI18nMap);

const schema = z.object({
  username: z.string().min(3).max(10),
  email: z.string().email(),
  favoriteNumber: z.number().max(10).min(1),
});

const Form = () => {
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm({
    resolver: zodResolver(schema),
  });
  
  return (
    <form onSubmit={handleSubmit(console.log)}>
      <FormControl isInvalid={!!errors.username} mb={4}>
        <FormLabel htmlFor="username">ユーザ名</FormLabel>
        <Input id="username" {...register("username")} />
        <FormErrorMessage>{(errors.username?.message ?? "")}</FormErrorMessage>
      </FormControl>
      <FormControl isInvalid={!!errors.email} mb={4}>
        <FormLabel htmlFor="email">メールアドレス</FormLabel>
        <Input id="email" {...register("email")} />
        <FormErrorMessage>{(errors.email?.message ?? "")}</FormErrorMessage>
      </FormControl>
      <FormControl isInvalid={!!errors.favoriteNumber} mb={4}>
        <FormLabel htmlFor="favoriteNumber">好きな数字</FormLabel>
        <Input id="favoriteNumber" {...register("favoriteNumber", { setValueAs: Number })} />
        <FormErrorMessage>{(errors.favoriteNumber?.message ?? "")}</FormErrorMessage>
      </FormControl>
      <Button mt={4} colorScheme="teal" isLoading={isSubmitting} type="submit">送信</Button>
    </form>
  )
}
```

実際のメッセージの定義はこんな感じ。

https://github.com/aiji42/zod-i18n/blob/main/packages/core/locales/ja/zod.json#L1-L19