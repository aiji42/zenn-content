---
title: "Next.jsã§ç‰¹å®šIPã§ã®ã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é–²è¦§ã‚’è¨±å¯ã™ã‚‹"
emoji: "ğŸ‘®â€â™‚ï¸"
type: "tech"
topics: ["nextjs", "vercel"]
published: true
---

## è¿½è¨˜(2022/01/21)

ã“ã¡ã‚‰ã®è¨˜äº‹ã¯ Next.js v10ã®é ƒã®è¨˜äº‹ã§ã‚ã‚Šã€ç¾åœ¨ã®v12ã§ã¯åŒã˜æ–¹æ³•ã§IPã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ã¯è¡Œãªãˆã¾ã›ã‚“ã€‚
ã—ã‹ã—ã€v12ã§ã¯middlewareã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¯èƒ½ã§ã™ã€‚
å…¬å¼ã®middlewareã®ã‚µãƒ³ãƒ—ãƒ«ãƒªã‚¹ãƒˆã«IPåˆ¶é™ã®ä¾‹ãŒã‚ã‚Šã¾ã™ã®ã§ã€ãã¡ã‚‰ã«å¾“ã£ã¦å®Ÿè£…ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/vercel/examples/tree/main/edge-functions/ip-blocking-datadome

ã¾ãŸã€ç­†è€…ã¯middlewareã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’çµ±æ‹¬ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

https://github.com/aiji42/next-fortress

å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚ˆã‚Šã¯ã‹ã‚“ãŸã‚“ã«å°å…¥ã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã®ã§ã€ãœã²æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã‚‚ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚

ä¸‹è¨˜ã‚µãƒ³ãƒ—ãƒ«ã¯ã€/adminé…ä¸‹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã—ã¦IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€è¨±å¯ãƒªã‚¹ãƒˆå¤–ã®IPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚ã‚Œã°ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å ´åˆã®ã‚‚ã®ã§ã™ã€‚
```ts
// /pages/admin/_middleware.ts
import { makeIPInspector } from 'next-fortress'

// ç¬¬ä¸€å¼•æ•°: è¨±å¯ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€‚CIDRå½¢å¼ã€ãŠã‚ˆã³é…åˆ—ã§è¤‡æ•°ã®IPæŒ‡å®šã‚‚å¯
// ç¬¬äºŒå¼•æ•°: è¨±å¯IPãƒ¬ãƒ³ã‚¸å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã—ã¦ã®åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«ã€‚è©³ã—ãã¯READMEã‚’ã©ã†ãã€‚https://github.com/aiji42/next-fortress#usage
export const middleware = makeIPInspector('123.123.123.123/32', {
  type: 'redirect',
  destination: '/'
})
```

IPã‚¢ãƒ‰ãƒ¬ã‚¹ä»¥å¤–ã«ã‚‚ firebaseã€auth0ã€aws cognito ã®èªè¨¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
2022/01/21æ™‚ç‚¹ã§ã¯ã€ã©ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚‚githubã®issueã¯ä¸ŠãŒã£ã¦ã„ã‚‹ã‚‚ã®ã®ã€ä¾ç„¶ã¨ã—ã¦middlewareã§ã®å‹•ä½œã¯æœªã‚µãƒãƒ¼ãƒˆã®çŠ¶æ…‹ã§ã™ã€‚
next-fortressã§ã¯ã€å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’JWTãƒ‘ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ã¦æ¤œè¨¼ã™ã‚‹ã“ã¨ã§(payloadã ã‘ã§ãªãã‚·ã‚°ãƒãƒãƒ£ã‚‚å«ã‚ã¦)ã€ç‹¬è‡ªã«èªè¨¼çŠ¶æ…‹ã®è§£æ±ºã‚’ã—ã¦ã„ã¾ã™ã€‚
è©³ã—ãã¯ [README](https://github.com/aiji42/next-fortress#readme) ã‚’å¾¡è¦§ãã ã•ã„ã€‚

---

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
Next.jsã§ä½œæˆã—ãŸã‚µã‚¤ãƒˆã®é–²è¦§ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§åˆ¶é™ã‚’ã‹ã‘ãŸã„ã€‚

Vercel ã¨ Next.js ã®çµ„ã¿åˆã‚ã›ã¯éå¸¸ã«ã‚ˆãã€é–‹ç™ºä½“é¨“ãŒéå¸¸ã«è‰¯ã„ã€‚
ã—ã‹ã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¡Œã†ãŸã‚ã«ã¯ã€è¿½åŠ æ–™é‡‘ã®æ”¯æ‰•ã„ãŒå¿…è¦ã€‚
**è‡ªå‰ã§ãƒãƒƒã‚¯ã—ã¦è²»ç”¨ã‚’ã‹ã‘ãšã«ã€ã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¶é™ã‚’è¡Œã„ãŸã„ã€‚**
![](https://storage.googleapis.com/zenn-user-upload/hkxys1r5q4od8k54bp6bo26e993q)

ä»Šå›ã¯æ¥­å‹™ã§ã‚ˆãã‚ã‚‹IPåˆ¶é™ã§ã®åˆ¶é™æ–¹æ³•ã‚’è¨˜è¼‰ã€‚

## ä»•çµ„ã¿
rewrites ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã€ç‰¹å®šã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä¿æŒã—ã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹ã¯ Deny ãƒšãƒ¼ã‚¸ã¸ã€ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä¿æŒã—ã¦ã„ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€é€šå¸¸é€šã‚Šã®ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã„ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é–²è¦§ã‚’å¯èƒ½ã«ã•ã›ã‚‹ã€‚
https://nextjs.org/docs/api-reference/next.config.js/rewrites#header-cookie-and-query-matching

å‰è¿°ã®ç‰¹å®šã‚¯ãƒƒã‚­ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã«ã€APIãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã€æŒ‡å®šã—ãŸIPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã—ã¦ã®ã¿ã€ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ã€‚
https://nextjs.org/docs/api-routes/api-middlewares#extending-the-reqres-objects-with-typescript

### æ³¨æ„
ä»•çµ„ã¿ã‚’è¦‹ã¦ã‚ã‹ã‚‹ã‚ˆã†ã«ã€IPã§åˆ¶é™ã¨ã¯ã„ãˆæ­£ç¢ºã«ã¯ã‚¯ãƒƒã‚­ãƒ¼ã§ã®åˆ¶é™ã«ãªã‚‹ã€‚
ã¤ã¾ã‚Šã€**ä¸€åº¦ã‚¯ãƒƒã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ã—ã¾ã£ãŸã‚ã¨ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã•ãˆå¤‰ãˆãªã‘ã‚Œã°IPã‚’å¤‰ãˆã¦ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã‚ã‚‹ã€‚**
å®Ÿéš›ã«ã¯ã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã‚’æœ‰é™æœŸé–“ã‹ã¤çŸ­ãè¨­å®šã™ã‚‹ã“ã¨ã§ã€ãªã‚‹ã¹ãå®‰å…¨ãªçŠ¶æ…‹ã‚’ç¢ºä¿ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã¾ãŸã€ä»Šå›ç´¹ä»‹ã™ã‚‹ã‚³ãƒ¼ãƒ‰åŠã³ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã‚ãã¾ã§ãƒ«ãƒ¼ãƒˆã®htmlã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ãã ã‘ã§ã€jsã‚„ç”»åƒãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯åˆ¶é™ã—ã¦ã„ãªã„ã€‚
å³å¯†ã«åˆ¶é™ã‚’ã‹ã‘ãŸã„ã®ã§ã‚ã‚Œã°ã€`/_next/`é…ä¸‹ã‚‚åŒã˜ã‚ˆã†ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

## è¨­å®š

api ãƒ«ãƒ¼ãƒˆã®ãƒ‘ã‚¹ä»¥å¤–ã§èªè¨¼ã‚¯ãƒƒã‚­ãƒ¼ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹
```js
// next.config.js
module.exports = {
  trailingSlash: true,
  rewrites: async () => {
    if (process.env.VERCEL_ENV !== 'preview') return {}
    return {
      beforeFiles: [
        {
          source: '/api/:path*/',
          destination: '/api/:path*',
        },
        {
          source: '/:path*/',
          has: [
            {
              type: 'cookie',
              key: 'x-custom-authorized',
              value: process.env.AUTH_KEY,  // AUTH_KEYã¯ãƒªãƒªãƒ¼ã‚¹ã”ã¨ã«å¤‰ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã‚ˆã‚Šè‰¯ã„
            },
          ],
          destination: '/:path*',
        },
        {
          source: '/:path*/',
          destination: '/challenge',
        }
      ]
    }
  }
}
```
https://github.com/aiji42/authrize-preview-sample/blob/main/next.config.js

**è£œè¶³**
ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚‚åˆ¶é™å¯¾è±¡ã«ã™ã‚‹ã«ã¯ã€ `trailingSlash: true` ã‚’è¨­å®šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒ«çš„ã«ã€ãƒˆãƒ¬ã‚¤ãƒªãƒ³ã‚°ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚ªãƒ•ã«ã—ãŸã„å ´åˆã«ã¯ã€`process.env.VERCEL_ENV` ãŒ preview ã®ã¨ãã®ã¿ true ã«ãªã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã‚„ã‚Œã°è‰¯ã„ã€‚

---

/api/passport ã¸æŒ‡å®šIPã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«èªè¨¼ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹
```ts
// util/setCookie.ts
import { serialize, CookieSerializeOptions } from 'cookie'
import { NextApiResponse } from 'next'

export const setCookie = (
  res: NextApiResponse,
  name: string,
  value: unknown,
  options: CookieSerializeOptions = {}
) => {
  const stringValue =
    typeof value === 'object' ? 'j:' + JSON.stringify(value) : String(value)

  if ('maxAge' in options) {
    options.expires = new Date(Date.now() + options.maxAge)
    options.maxAge /= 1000
  }

  res.setHeader('Set-Cookie', serialize(name, String(stringValue), options))
}

// pages/api/passport.ts
import { NextApiHandler } from 'next'
import { setCookie } from '../../util/setCookie'

const handler: NextApiHandler = (req, res) => {
  if (process.env.AUTH_KEY && process.env.ALLOW_FROM && req.headers['x-forwarded-for']?.includes(process.env.ALLOW_FROM)) {
    setCookie(res, 'x-custom-authorized', process.env.AUTH_KEY, { path: '/' })
    res.end(res.getHeader('Set-Cookie'))
    return
  }
  res.status(401).json({ message: 'Unauthorized' })
}

export default handler
```
https://github.com/aiji42/authrize-preview-sample/blob/main/util/setCookie.ts
https://github.com/aiji42/authrize-preview-sample/blob/main/pages/api/passport.ts

---

èªè¨¼ã‚’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸ã€‚
cookie ã‚’ä¿æŒã—ã¦ã„ãªã‘ã‚Œã°ã€rewrite ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã€‚
```tsx
// pages/challenge.tsx
import Head from 'next/head'
import Image from 'next/image'
import styles from '../styles/Home.module.css'
import { FC, useEffect } from 'react'
import { useRouter } from 'next/router'

const Challenge: FC = () => {
  const router = useRouter()
  // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«èªè¨¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
  useEffect(() => {
    fetch('/api/passport')
      .then(({ ok }) => {
        ok && router.reload()
      })
  }, [])

  return (
    <div className={styles.container}>
      <Head>
        <title>Deny your access</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title}>
          Deny your access
        </h1>
      </main>

      <footer className={styles.footer}>
        <a
          href="https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
          target="_blank"
          rel="noopener noreferrer"
        >
          Powered by{' '}
          <span className={styles.logo}>
            <Image src="/vercel.svg" alt="Vercel Logo" width={72} height={16} />
          </span>
        </a>
      </footer>
    </div>
  )
}

export default Challenge
```
https://github.com/aiji42/authrize-preview-sample/blob/main/pages/challenge.tsx

## ãƒ‡ãƒ—ãƒ­ã‚¤
ä¸‹è¨˜ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
```
ALLOW_FROM=è¨±å¯ã—ãŸã„IP
AUTH_KEY=é©å½“ãªæ–‡å­—åˆ—
```

## ãƒ‡ãƒ¢
åˆ¶é™ã‹ã‘ã¦ã„ãªã„æ–¹(production)
https://authrize-preview-sample.vercel.app/

åˆ¶é™ã‹ã‘ã¦ã„ã‚‹æ–¹(preview)
https://authrize-preview-sample-5oesakgya-aiji42.vercel.app/

