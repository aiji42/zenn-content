---
title: "ã€Next.jsã€‘ã¿ã‚“ãª next.confing.js ã«ã©ã‚“ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³å…¥ã‚Œã¦ã‚‹ï¼Ÿ"
emoji: "ğŸŒµ"
type: "tech"
topics: ["nextjs"]
published: true
---

https://twitter.com/aiji42_dev/status/1415711986608795648?s=20

---

![](https://storage.googleapis.com/zenn-user-upload/79ea55919574a163142b6864.png =500x)
*Why Next.js*

ç§ã¯ã€æ¥­å‹™ã§ã‚‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã‚‚ Next.js ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
Next.js ã¯ "Zero Config" ã‚’ã†ãŸã£ã¦ã„ã‚‹ã‚ã‘ã§ã™ãŒã€å®Ÿéš›æ¥­å‹™ã§ä½¿ã†ã¨ãªã‚‹ã¨ã€ãªã‹ãªã‹ Zero ã¨ã¯ã„ãã¾ã›ã‚“ã€‚IE11ç”¨ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ã«ãªã£ãŸã‚Šã€ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãŸã‚ã« webpack ã®æ‹¡å¼µãŒå¿…è¦ãªã‚‹ã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã¯ã€`next.config.js` ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ãã†ã„ã£ãŸã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’ã‚µãƒãƒ¼ãƒˆã—ã€è¨­å®šã®ã‚¹ãƒˆãƒ¬ã‚¹ã‹ã‚‰æˆ‘ã€…ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’é–‹æ”¾ã—ã¦ãã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒä¸–ã®ä¸­ã«ã¯ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã€è‡ªåˆ†ä»¥å¤–ã®æ–¹ã€…ãŒ `next.config.js` ã«ã©ã®ã‚ˆã†ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¥ã‚Œã¦ã„ã‚‹ã‹æ°—ã«ãªã‚Šã¾ã—ãŸã€‚

ã¾ãšã¯ã€è‡ªåˆ†ãŒã©ã®ã‚ˆã†ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¥ã‚Œã¦ã„ã‚‹ã‹ã‚·ã‚§ã‚¢ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ã€Œè‡ªåˆ†ã¯ã“ã‚“ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³å…¥ã‚Œã¦ã„ã¦ä¾¿åˆ©ã§ã™ã‚ˆã€ã¿ãŸã„ãªã‚·ã‚§ã‚¢ã‚’ã€Twitter ã‚„ Zenn ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚

## 1. @next/bundle-analyzer (ãƒãƒ³ãƒ‰ãƒ«ã‚¢ãƒŠãƒ©ã‚¤ã‚¶)

https://github.com/vercel/next.js/tree/canary/packages/next-bundle-analyzer

Next.js ãŒå…¬å¼ã«æä¾›ã—ã¦ã„ã‚‹ãƒãƒ³ãƒ‰ãƒ«ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ã§ã™ã€‚
Next.js ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ–¹ã€…ã¯æ˜¨ä»Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äº‹æƒ…ã«å¯¾ã—ã¦ã®é–¢å¿ƒãŒé«˜ã„ã¨æ€ã„ã¾ã™ã®ã§ã€åˆ†æã«æ´»ç”¨ã—ã¦ã„ã‚‹ã¨ã„ã†äººã¯å¤šã„ã¨æ€ã„ã¾ã™ã€‚

ã“ã‚“ãªæ„Ÿã˜ã§è¨­å®šã‚’ã—ã¾ã™ã€‚
```js
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
})
module.exports = withBundleAnalyzer({
  // next.jsã®è¨­å®š
})
```
```
ANALYZE=true yarn build 
```
ã¨å®Ÿè¡Œã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒãƒ³ãƒ‰ãƒ«ãƒãƒƒãƒ—ã‚’ä½œæˆã™ã‚‹ã¨åŒæ™‚ã«ã€è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ç«‹ã¡ä¸Šã’ã¦ãã‚Œã¾ã™ã€‚

|ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰|ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰|
|---|---|
| ![](https://storage.googleapis.com/zenn-user-upload/190a47bbe5d9caa3014520c8.png) | ![](https://storage.googleapis.com/zenn-user-upload/c08144a8f5587c1dfcbe8ecd.png) |


ä¸è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚ã‚‹ã„ã¯ä¸€éƒ¨ãƒšãƒ¼ã‚¸ã§ã—ã‹ä½¿ã‚ã‚Œã¦ã„ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…±é€šéƒ¨åˆ†ã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã„ãªã„ã‹ãªã©ã‚’ç¢ºèªã—ã¦ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã«å½¹ç«‹ã¦ã¾ã—ã‚‡ã†ã€‚

ã‚ã‚‹ã‚³ãƒ³ãƒãƒãƒ³ãƒˆã‚’ Dynamic Import ã§é€€é¿ã—ãŸã«ã‚‚é–¢ã‚ã‚‰ãšã€é–¢é€£ã‚½ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æ™®é€šã® import ã§æ›¸ã„ã¦ã—ã¾ã£ã¦ãŠã‚Šã€å®Ÿã¯å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ãŸâ€¦ã¨ã„ã†ã‚ã‚‹ã‚ã‚‹ãƒŸã‚¹ã‚‚ã€å¯¾è±¡ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã•ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã“ã¨ã§é˜²ã’ã¾ã™ã€‚

## 2. next-transpile-modules (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«)

https://github.com/martpie/next-transpile-modules#readme

node_modules å†…ã®æŒ‡å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚
IE11ã®ã‚µãƒãƒ¼ãƒˆãŒæ¥å¹´2022å¹´ã®6æœˆã§çµ‚äº†ã—ã¾ã™ãŒã€ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹æ€§ä¸ŠIEã§ã®å‹•ä½œã‚’è€ƒæ…®ã—ç¶šã‘ãªã‘ã‚Œã°ã„ã‘ãªã„ã¨ã„ã†çŠ¶æ³ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ã¯ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã—ãªã„ã¨IEã§å‹•ã‹ãªã„ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€ãã†ã£ãŸã‚‚ã®ã‚’å¯¾è±¡ã«æŒ‡å®šã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

```js
const withTM = require('next-transpile-modules')([
  'somemodule',
  'and-another'
])

module.exports = withTM({
  // next.jsã®è¨­å®š
})
```

ç§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€`@react-google-maps/api` å†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€`@googlemaps/js-api-loader` ã‚„ã€`fill-range` å†…ã® `to-regex-range` ãªã©ãŒãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ã§ã‚ã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã‚’å¯¾è±¡ã«ã—ã¦ã—ã¦ã„ã¾ã™ã€‚
```js
const withTM = require('next-transpile-modules')([
  '@googlemaps/js-api-loader',
  'to-regex-range'
])
```

:::message
Next.js ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ `next-transpile-modules` å´ã®å¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚Šã¾ã™ã€‚READMEã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§å°å…¥ã®éš›ã¯ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚
:::
https://github.com/martpie/next-transpile-modules#compatibility-table


## 3. next-with-split (A/Bãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–)

https://github.com/aiji42/next-with-split#ab-next-with-split

ãƒ–ãƒ©ãƒ³ãƒãƒ™ãƒ¼ã‚¹ãƒ»CDNãƒ™ãƒ¼ã‚¹ã§A/Bãƒ†ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚
ä½•ã‚’éš ãã†ã€ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹ç§è‡ªèº«ãŒã‚ªãƒ¼ãƒŠãƒ¼ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚

ä»¥å‰ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã§ç´¹ä»‹ã‚’ã•ã›ã¦ã„ãŸã ã„ã¦ã„ã‚‹ã®ã§ã™ãŒã€
https://zenn.dev/aiji42/articles/d635ce025efdd2
ã“ã®è¨˜äº‹æ™‚ç‚¹ã‹ã‚‰2åº¦ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’é‡ã­ã¦ãŠã‚Šã€å°å…¥ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã£ãŸã ã‘ã§ãªãã€Vercelæ„å¤–ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã‚‚å¯¾å¿œã—ã¦ã„ãŸã‚Šã¨ã€ã•ã¾ã–ã¾ãªå•é¡ŒãŒè§£æ¶ˆã•ã‚Œã¦ã„ã¾ã™ã€‚(ä¸Šã®è¨˜äº‹ã®æƒ…å ±ã¯å¤ãã€è¨­å®šæ–¹æ³•ãŒç•°ãªã‚‹ãŸã‚ã”æ³¨æ„ãã ã•ã„ã€‚å‚è€ƒæƒ…å ±ã¨ã—ã¦è²¼ã£ã¦ãŠãã¾ã™ã€‚)

ãƒ–ãƒ©ãƒ³ãƒãƒ™ãƒ¼ã‚¹ã®A/Bãƒ†ã‚¹ãƒˆã§ã‚ã‚‹ãŸã‚ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã¨ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã‚³ãƒ¼ãƒ‰ã¯ã€Gitã®ãƒ–ãƒ©ãƒ³ãƒä¸Šã§å®Œå…¨ã«åˆ‡ã‚Šåˆ†ã‘ã¦ç®¡ç†ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãã®ãŸã‚ã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®å¢—åŠ ã‚’é˜²ã’ã¾ã™ã—ã€ä½•ã‚ˆã‚Šç®¡ç†ãŒæ¥½ãªã®ã§é–‹ç™ºä½“é¨“ãŒã‚ˆããªã‚Šã¾ã™ã€‚

è¨­å®šæ–¹æ³•ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
```js
const withSplit = require('next-with-split')({
  splits: {
    example1: {
      path: '/foo/bar/:path*',
      hosts: {
        original: 'example.com',
        challenger: 'challenger-for-example1.vercel.app',
      }
    }
  }
})

module.exports = withSplit({
  // next.jsã®è¨­å®š
})
```

è©³ã—ãã¯ README ã‚’å‚ç…§ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
https://github.com/aiji42/next-with-split#ab-next-with-split

## 4. @sentry/nextjs (ã‚¨ãƒ©ãƒ¼æ•æ‰ãƒ»åˆ†æ)

ã‚¨ãƒ©ãƒ¼ã®è£œè¶³ã« Sentry ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹æ–¹ã‚‚å¤šã„ã¨æ€ã„ã¾ã™ã€‚
https://sentry.io/welcome/

ä»Šå¹´ã®æ˜¥ã¾ã§å…¬å¼ã®ã‚µãƒãƒ¼ãƒˆãŒãªãã€Next.js ã«å°å…¥ã™ã‚‹å ´åˆã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«ã¯ `@sentry/node` ã‚’ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«ã¯ `@sentry/browser` ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§å¯¾å¿œã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã—ãŸã€‚(webpackã®è¨­å®šã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æ›¸ãæ›ãˆã¦2ã¤ã‚’å‡ºã—åˆ†ã‘ã‚‹ã¨ã„ã†ã‚¦ã‚§ãƒ–ãƒ‘ãƒƒç­‹ãŒå¿…è¦ã§ã—ãŸã€‚æ‡ã‹ã—ã„ã§ã™ã­ã€‚)
ã—ã‹ã—ã€ã¤ã„ã«å…¬å¼ã®ã‚µãƒãƒ¼ãƒˆãŒè¡Œã‚ã‚Œã€webpackã®æ‹¡å¼µæ€§ã£ã¦ã„ãŒä¸è¦ã«ãªã£ãŸã ã‘ã§ãªãã€ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚„DSNå€¤ã®å–å¾—ã¨å±•é–‹ã‚’è‡ªå‹•ã§è¡Œã£ã¦ãã‚Œã¾ã™ã€‚(ãªã‚“ã¨è‡ªå‰ã§Sentryã‚’ãƒ›ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚)

å°å…¥ã¯ã€yarn(ã‚‚ã—ãã¯npm)ã§ `@sentry/nextjs` ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã—ãŸã‚ã¨ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¾ã™ã€‚
```
npx @sentry/wizard -i nextjs # è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶ãŒç«‹ã¡ä¸ŠãŒã‚‹ã®ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹

# è‡ªå‰ã§ Sentryã‚µãƒ¼ãƒã‚’ãƒ›ã‚¹ãƒˆã—ã¦ã„ã‚‹å ´åˆã¯ã“ã¡ã‚‰
npx @sentry/wizard -i nextjs --url ${ã“ã“ã«è‡ªå‰ã®URLã‚’}
```

ãã†ã—ã¾ã™ã¨ã€ `sentry.client.config.js` `sentry.server.config.js` `sentry.properties` ã“ã‚Œã‚‰3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚é †ç•ªã«ã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€å…±é€šã®è¨­å®šå€¤(ãƒˆãƒ¼ã‚¯ãƒ³ãªã©)ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
:::message
`sentry.properties` ã«é–¢ã—ã¦ã¯ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã£ã¦ä»£æ›¿å¯èƒ½ã§ã™ã€‚
ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒªãƒã‚¸ãƒˆãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«å«ã‚ã‚‹ã¹ãã§ã¯ãªã„ã¨æ€ã„ã¾ã™ã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨å‰Šé™¤ã™ã‚‹ã‹ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ç’°å¢ƒå¤‰æ•° `SENTRY_AUTH_TOKEN` ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
ãã®ä»–ã®åˆ©ç”¨å¯èƒ½ãªç’°å¢ƒå¤‰æ•°ã¯[ã“ã¡ã‚‰](https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#use-environment-variables)
:::


ãã—ã¦ã€ next.config.js ã«æ¬¡ã®ã‚ˆã†ãªè¨­å®šã‚’æ–½ã—ã¾ã™ã€‚
```js
const { withSentryConfig } = require('@sentry/nextjs')

module.exports = withSentryConfig({
  // next.jsã®è¨­å®š
}, {
  // Sentery ã® webpack ã«é–¢ã™ã‚‹è¨­å®š
})
```
ã“ã¡ã‚‰ã¯ä¸»ã«ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ã«é–¢ã—ã¦ã®è¨­å®šã«ãªã‚Šã¾ã™ã€‚

ãã®ä»–ã€è©³ã—ã„è¨­å®šã«é–¢ã—ã¦ã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/

### è£œè¶³1

2021/07/17 ç¾åœ¨ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹ã€v6.9.0 ã«ãŠã„ã¦ã¯ã€next config ã® `target`å€¤ã‚’ `serverless` ã«ã—ã¦ã„ã‚‹ã¨ã€ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
Vercel ã§ãƒ‡ãƒ—ãƒ­ã‚¤æŒ‡å®šåˆ†ã«ã¯å•é¡Œãªã„ã¨æ€ã„ã¾ã™ãŒã€[serverless-nextjs](https://github.com/serverless-nextjs/serverless-next.js)ãªã©ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

https://github.com/serverless-nextjs/serverless-next.js/issues/1038

ã¡ãªã¿ã«ã€ç§ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ã®ã¿ `serverless-nextjs` ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€æ¬¡ã®ã‚ˆã†ãªæ–¹æ³•ã§å•é¡Œã‚’å›é¿ã—ã¦ã„ã¾ã™ã€‚
https://twitter.com/aiji42_dev/status/1415702271485124614?s=20

### è£œè¶³2

å‰è¿°ã—ãŸ `@next/bundle-analyzer` ã¨ã®ç›¸æ€§ãŒæ‚ªãã€åŒæ™‚ã«ç¨¼åƒã•ã›ã‚‹ã¨ã„ã†ã“ã¨ãŒã§ããªã„ã‚ˆã†ã§ã™ã€‚(ä½µç”¨ã—ã¦ã„ã¦ã‚‚ `ANALYZE=true` ã§èµ·å‹•ã—ãªã„é™ã‚Šã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚)

ãã®ãŸã‚ã€`process.env.ANALYZE === 'true'` ãŒæ­£ã¨ãªã‚‹ã‚±ãƒ¼ã‚¹ã§ã€`withSentryConfig` ãŒãƒ€ãƒŸãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãªã‚‹ã‚ˆã†ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦ã‚ã’ã‚‹ãªã©ã®å·¥å¤«ãŒå¿…è¦ã§ã™ã€‚(ç§ã¯ã“ã‚“ãªæ„Ÿã˜ã§å›é¿ã—ã¦ã„ã¾ã™)
```js
const { withSentryConfig } =
  process.env.ANALYZE !== 'true'
    ? require('@sentry/nextjs')
    : { withSentryConfig: (config) => config }
```

## ç•ªå¤–ç·¨: next-compose-plugins
https://github.com/cyrilwanner/next-compose-plugins

ã“ã‚Œã¾ã§ã€4ã¤ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç´¹ä»‹ã—ã¾ã—ãŸãŒã€è¤‡æ•°ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’åŒæ™‚ã«ä½¿ç”¨ã™ã‚‹å ´åˆã«ã¯ã€è¤‡æ•°ã®ãƒã‚¹ãƒˆãŒç™ºç”Ÿã—ã¦ã—ã¾ã„å¯èª­æ€§ãŒä¸‹ãŒã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã†ã„ã£ãŸå ´åˆã«ã€ã“ã® `next-compose-plugins` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æŸã­ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```js
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
})
const withTM = require('next-transpile-modules')([
  'somemodule',
  'and-another'
])
const withSplit = require('next-with-split')({
  splits: {
    example1: {
      path: '/foo/bar/:path*',
      hosts: {
        original: 'example.com',
        challenger: 'challenger-for-example1.vercel.app',
      }
    }
  }
})
// withSentryConfig ã ã‘ã€å¼•æ•°ã®æ•°ãŒç•°ãªã‚‹ãŸã‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¿…è¦
const withSentryConfig = (config) => {
  // withBundleAnalyzer ã¨ã®ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°å›é¿
  if (process.env.ANALYZE === 'true') return config
  return require('@sentry/nextjs').withSentryConfig(config, {
    // Sentery ã® webpack ã«é–¢ã™ã‚‹è¨­å®š
  })
}

const withPlugins = require('next-compose-plugins')
// ãƒã‚¹ãƒˆã—ãŸã„é †ã«é…åˆ—ã«æ¸¡ã™ã ã‘
module.exports = withPlugins([
  withSplit,
  withTM,
  withSentryConfig,
  withBundleAnalyzer
], {
  // next.jsã®è¨­å®š
})
```

---

## æœ€å¾Œã«

ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
å†’é ­ã«ã‚‚è¨˜è¼‰ã—ãŸã‚ˆã†ã«ã€ã€Œè‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã“ã‚“ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã€ã¿ãŸã„ãªç´¹ä»‹ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚„Twitterã§è¿”ä¿¡ãã ã•ã„ã€‚