---
title: "Nodeç’°å¢ƒã§ã® Cloud Logging ã¨ Error Report ã®ä»•æ§˜ã‚’å®Ÿé¨“ã—ã¦ç¢ºèªã—ã¦ã¿ãŸ"
emoji: "ğŸš¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nodejs, gcp, cloudrun, logging]
published: false
---

GCP ã® Cloud Run ã§ Node ã®ã‚µãƒ¼ãƒã‚’ç¨¼åƒã•ã›ã€Cloud Logging ã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ã€æ›´ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã¨ãã¯ Error Report ã§é€šçŸ¥ã‚’å—ã‘ã‚‹ã¨ã„ã†ã‚ˆã†ãªæ§‹æˆã‚’çµ„ã‚€éš›ã«ã€
- ã©ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã€Œé‡è¦åº¦ã€ãŒæ­£ã—ããƒãƒ¼ã‚¯ã•ã‚Œã‚‹ã®ã‹
- ã©ã®ã‚ˆã†ãªå½¢å¼ã§ãƒ­ã‚°ã‚’åã‘ã° Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã®ã‹
 
ã“ã‚Œã‚‰ã®ã“ã¨ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã‚‚ã„ã¾ã„ã¡ã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§å®Ÿé¨“ã—ã¦ã¿ã¾ã—ãŸã€‚  

ã¾ãŸã€æ¨™æº–ã® `console` ã ã‘ã§ã¯ãªãã€Node ã®ä¸»è¦ãªãƒ­ã‚¬ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ã†ã¡ã€ã©ã‚ŒãŒä¸€ç•ª Cloud Logging ã¨ Error Report ã¨ã®ç›¸æ€§ãŒè‰¯ã„ã®ã‹ã‚‚å®Ÿé¨“ã‹ã‚‰å°ãå‡ºã—ã¾ã—ãŸã€‚

## å‰æ

### ãƒ­ã‚®ãƒ³ã‚°æ–¹æ³•

Cloud Run ã§ express ã‚µãƒ¼ãƒã‚’ç”¨æ„ã—ã€ä¸‹è¨˜ã®ã‚ˆã†ã«æ–‡å­—åˆ—ã¨ Error ã‚’ãƒ­ã‚¬ãƒ¼ã§æ¨™æº–å‡ºåŠ›ãŠã‚ˆã³æ¨™æº–ã‚¨ãƒ©ãƒ¼ã«å‡ºåŠ›

```ts
app.get("/", (req, res) => {
  logger.info('error massage')            
  logger.info(new Error('error message'))
  logger.warn('error massage')            
  logger.warn(new Error('error message'))
  logger.error('error massage')          
  logger.error(new Error('error message'))

  res.send();
});
```

### ä½¿ç”¨ãƒ­ã‚¬ãƒ¼

- console
- [winston](https://github.com/winstonjs/winston)
- [bunyan](https://github.com/trentm/node-bunyan)
- [pino](https://github.com/pinojs/pino)
- [loglevel](https://github.com/pimterry/loglevel)

[npmlog](https://github.com/npm/npmlog)ã¯ãƒ­ã‚¬ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã§ä¸€ç•ªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°ãŒå¤šã„æœ‰åãªãƒ­ã‚¬ãƒ¼ã ãŒã€Errorã‚’å‡ºåŠ›ã™ã‚‹ã®ã«ã¯ã‚ã¾ã‚Šå‘ã„ã¦ã„ãªã„ãŸã‚æœ¬èª¿æŸ»ã§ã¯å¯¾è±¡å¤–ã¨ã™ã‚‹

### è©•ä¾¡æ–¹æ³•

- Cloud Logging ã®ã€Œé‡è¦åº¦ã€ãŒã©ã†ãªã‚‹ã‹
- Error Report ãŒç”Ÿæˆã•ã‚Œã‚‹ã‹ã©ã†ã‹

### ãã‚‚ãã‚‚...

[@google-cloud/logging](https://github.com/googleapis/nodejs-logging)ã‚’åˆ©ç”¨ã—ãŸã‚Šã€ã‚ã‚‹ã„ã¯ã€GCPãŒå…¬å¼ã«ç”¨æ„ã—ã¦ã„ã‚‹ winston ã‚„ bunyan ç”¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç”¨ã„ã‚Œã°ã€Logging ã¨ Reporting ã¯æ­£ã—ãè¡Œãˆã¾ã™ã€‚  

https://cloud.google.com/logging/docs/setup/nodejs?hl=ja

ã—ã‹ã—å†…éƒ¨çš„ã«ã¯ GRPC ã§ã®é€šä¿¡ã‚’ç™ºç”Ÿã•ã›ã¦ API ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ã®ã§ã€ãƒ­ã‚®ãƒ³ã‚°ã«ãã“ã¾ã§ã‚³ã‚¹ãƒˆã‚’ã‹ã‘ãŸããªã„(æ¨™æº–å‡ºåŠ›ã«åãã ã‘ã§ã„ã„ã®ã§ã‚ã‚Œã°ã€ãã‚Œã«è¶Šã—ãŸã“ã¨ã¯ãªã„)ã¨ã„ã†æ°—æŒã¡ãŒå¼·ã‹ã£ãŸã®ã§ã€ã“ã®å®Ÿé¨“ã«è‡³ã‚Šã¾ã—ãŸã€‚  
ã“ã¡ã‚‰ã®è¨˜äº‹ã§ moga ã•ã‚“ã‚‚åŒæ§˜ã®ã“ã¨ã‚’è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

https://zenn.dev/moga/articles/cloudrun-structured-log

## Cloud Logging ã®é‡è¦åº¦ã«é–¢ã—ã¦

https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry?hl=ja#LogSeverity

ãƒ­ã‚°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã—ã¦æ§‹é€ åŒ–ã—ã€`severity` ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã€Œé‡è¦åº¦ã€ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  
`INFO`, `WARNING`, `ERROR`ãªã©ã‚’å–ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚(ä»–ã®å€¤ã¯ä¸Šè¨˜ã‚µã‚¤ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚)
`severity` ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„ã¨ãã¯ DEFAULT ã¨ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€`severity` ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„ã¨ãã§ã‚‚ã€ãƒ­ã‚°ã®å†…å®¹ãŒã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹å ´åˆã¯ã€è‡ªå‹•çš„ã« `ERROR` ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã¾ã™ã€‚
:::message
ã¡ãªã¿ã«ç§ã¯ã€Error ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°å‡ºåŠ›ã«ã¯ `console.error` ã§ã‚„ã‚‹ã“ã¨ãŒå¤šã‹ã£ãŸãŸã‚ã€ã€Œé‡è¦åº¦ã‚¨ãƒ©ãƒ¼ã€ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã‚‹æ¡ä»¶ã‚’ã€
ã€Œ`stderr(æ¨™æº–ã‚¨ãƒ©ãƒ¼)` ã§å‡ºåŠ›ã—ãŸã¨ãã¯è‡ªå‹•çš„ã«é‡è¦åº¦ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€
ã¨å‹˜é•ã„ã—ã¦ã„ã¾ã—ãŸã€‚  

åŒã˜ã‚ˆã†ãªå‹˜é•ã„ã‚’ã—ã¦ã„ã‚‹äººã¯å°‘ãªã„ã¨æ€ã„ã¾ã™ãŒã€`console.error` ã‚„ `stderr` ã‹ã©ã†ã‹ã§ã¯ãªãã€ã€Œ`severity` ã®æŒ‡å®šãŒãªãå‡ºåŠ›å†…å®¹ãŒã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã‚ã‚‹ã¨ãã€ã¨ã„ã†ã®ãŒæ­£ã—ã„æ¡ä»¶ã§ã™ã®ã§ã€æ³¨æ„å–šèµ·ã—ã¦ãŠãã¾ã™ã€‚
:::

ã“ã®è¨˜äº‹ã§ã¯ Cloud Logging ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãã®ã¾ã¾è¼‰ã›ã¾ã™ã€‚é‡è¦åº¦ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ã‚¤ã‚³ãƒ³ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

| DEFAULT                                | INFO                                | WARNING                             | ERROR                                |
|----------------------------------------|-------------------------------------|-------------------------------------|--------------------------------------|
| ![](/images/cloud-logging-default.png) | ![](/images/cloud-logging-info.png) | ![](/images/cloud-logging-warn.png) | ![](/images/cloud-logging-error.png) |

## Error Report ã«é–¢ã—ã¦

ã“ã®è¨˜äº‹ã§ã¯ Cloud Logging ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãã®ã¾ã¾è¼‰ã›ã¾ã™ã€‚Error Report ãŒç”Ÿæˆã•ã‚ŒãŸæ—¨ã«é–¢ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ã‚¤ã‚³ãƒ³ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/error-report-icon.png)

## å®Ÿé¨“â‘ : console

`console.log`, `console.warn`, `console.error` ã‚’ä½¿ç”¨ã—ã€æ–‡å­—åˆ—ã¨ Error ã‚’ãã®ã¾ã¾ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å‡ºåŠ›ã•ã›ã¾ã—ãŸã€‚

**çµæœ**
```ts
console.log('error massage')              // é‡è¦åº¦: DEFAULT | ErrorReporting: 
console.log(new Error('error message'))   // é‡è¦åº¦: ERROR   | ErrorReporting: â—‹
console.warn('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReporting: 
console.warn(new Error('error message'))  // é‡è¦åº¦: ERROR   | ErrorReporting: â—‹
console.error('error massage')            // é‡è¦åº¦: DEFAULT | ErrorReporting:
console.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReporting: â—‹
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

ä¸Šè¨˜ã®è¨˜è¿°é †ã¨å‡ºåŠ›é †ã«è‹¥å¹²ã®ã‚ºãƒ¬ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ä¸‹ã•ã„ã€‚

![](/images/gcp-logging-console.png)

Error ã‚’å‡ºåŠ›ã—ãŸã‚‚ã®ã«é–¢ã—ã¦ã¯ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«é–¢ä¿‚ãªãã€Error Report ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚  
ã¾ãŸã€`severity`ã‚’è¨­å®šã—ã¦ã„ãªã„ã®ã§ã€é‡è¦åº¦ã¯æ–‡å­—åˆ—ã¯ä¸€å¾‹ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€Error ã‚’å‡ºåŠ›ã—ãŸã‚‚ã®ã¯ä¸€å¾‹ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã—ãŸã€‚

ã¡ãªã¿ã«ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã§ suin ã•ã‚“ãŒã€

https://qiita.com/suin/items/d5d5d7199b62eed63bde

> JavaScriptã®Console APIã®ãƒ¡ã‚½ãƒƒãƒ‰ã®é•ã„ã¯ã€åŸºæœ¬çš„ã«GCPã®é‡å¤§åº¦ã«å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ãŸã ã—ã€console.warnã¨console.errorãŒErrorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ã‚®ãƒ³ã‚°ã—ãŸå ´åˆã«é™ã‚Šã€é‡å¤§åº¦ãŒã€ŒERRORã€ã«ãªã‚Šã¾ã™ã€‚

ã¨è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€‚2022å¹´12æœˆæ™‚ç‚¹ã§ã¯ã€Error ã‚’å‡ºåŠ›ã—ãŸå ´åˆã¯ã™ã¹ã¦(`.log`ã§ã‚‚)é‡è¦åº¦ã¯ ERROR ã«ãªã‚Šã¾ã—ãŸã€‚  
suin ã•ã‚“ãŒè¨˜äº‹ã‚’æ›¸ã‹ã‚ŒãŸã®ãŒ2020å¹´8æœˆãªã®ã§ã€ãã‚Œä»¥é™ã§ä»•æ§˜å¤‰æ›´ãŒã‚ã£ãŸã®ã‹ã€ã‚ã‚‹ã„ã¯Cloud Runã‹ã‚‰ã®å‡ºåŠ›ãŒåŸå› ãªã®ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚

### ã‚«ã‚¹ã‚¿ãƒ ã—ã¦é‡è¦åº¦ãŒå¤‰ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹

å‡ºåŠ›ã™ã‚‹å†…å®¹ã‚’ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® `JSON.stringify` ã—ãŸã‚‚ã®ã«ã™ã‚‹ã¨ã€Cloud Logging ãŒæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚  
`severity` ã«é‡è¦åº¦ã®ãƒ¬ãƒ™ãƒ«ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹ã¨ã€æ„å›³ã—ãŸã¨ãŠã‚Šã«é‡è¦åº¦ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const makeLogger = (severity: "INFO" | "WARNING" | "ERROR") => {
  return (entry: any, meta?: Record<string, any>) => {
    console.log(
      JSON.stringify({
        severity,
        message: entry instanceof Error ? entry.stack : entry,
        ...meta,
      })
    );
  };
};

const logger = {
  info: makeLogger("INFO"),
  warn: makeLogger("WARNING"),
  error: makeLogger("ERROR"),
};
```
```ts
logger.info('error massage')             // é‡è¦åº¦: INFO    | ErrorReporting: 
logger.info(new Error('error message'))  // é‡è¦åº¦: INFO    | ErrorReporting:
logger.warn('error massage')             // é‡è¦åº¦: WARNING | ErrorReporting: 
logger.warn(new Error('error message'))  // é‡è¦åº¦: WARNING | ErrorReporting:
logger.error('error massage')            // é‡è¦åº¦: ERROR   | ErrorReporting:
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReporting: â—‹
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

![](/images/gcp-logging-console-custom.png)

`severity` ãŒä¸ãˆã‚‰ã‚ŒãŸã“ã¨ã§ã€loggerã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¨é‡è¦åº¦ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚  
ã¾ãŸã€`severity` ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã¨ãã« Error ã‚’å‡ºåŠ›ã—ãŸå ´åˆã«ã€Error Report ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã¯é‡è¦åº¦ãŒã‚¨ãƒ©ãƒ¼ä»¥ä¸Šã®ã‚‚ã®ã ã‘ã«ãªã‚Šã¾ã™ã€‚

## å®Ÿé¨“â‘¡: winston

## å®Ÿé¨“â‘¢: bunyan

## å®Ÿé¨“â‘£: pino

## å®Ÿé¨“â‘¤: loglevel

## ç•ªå¤–ç·¨

## ã¾ã¨ã‚