---
title: "Node環境での Cloud Logging と Error Report の仕様を実験して確認してみた"
emoji: "🚥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [nodejs, gcp, cloudrun, logging]
published: false
---

GCP の Cloud Run で Node のサーバを稼働させ、Cloud Logging にログを出力して、更にエラーが発生したときは Error Report で通知を受けるというような構成を組む際に、
- どのようなケースで「重要度」が正しくマークされるのか
- どのような形式でログを吐けば Error Report が自動生成されるのか
 
これらのことが、ドキュメントを読んでもいまいちわからなかったので実験してみました。  

また、標準の `console` だけではなく、Node の主要なロガーライブラリーのうち、どれが一番 Cloud Logging と Error Report との相性が良いのかも実験から導き出しました。

## 前提

### ロギング方法

Cloud Run で express サーバを用意し、下記のように文字列と Error をロガーで標準出力および標準エラーに出力

```ts
app.get("/", (req, res) => {
  logger.info('error massage')            
  logger.info(new Error('error message'))
  logger.warn('error massage')            
  logger.warn(new Error('error message'))
  logger.error('error massage')          
  logger.error(new Error('error message'))

  res.send();
});
```

### 使用ロガー

- console
- [winston](https://github.com/winstonjs/winston)
- [bunyan](https://github.com/trentm/node-bunyan)
- [pino](https://github.com/pinojs/pino)
- [loglevel](https://github.com/pimterry/loglevel)

[npmlog](https://github.com/npm/npmlog)はロガーライブラリの中で一番ダウンロード数が多い有名なロガーだが、Errorを出力するのにはあまり向いていないため本調査では対象外とする

### 評価方法

- Cloud Logging の「重要度」がどうなるか
- Error Report が生成されるかどうか

### そもそも...

[@google-cloud/logging](https://github.com/googleapis/nodejs-logging)を利用したり、あるいは、GCPが公式に用意している winston や bunyan 用のプラグインを用いれば、Logging と Reporting は正しく行えます。  

https://cloud.google.com/logging/docs/setup/nodejs?hl=ja

しかし内部的には GRPC での通信を発生させて API をリクエストしているので、ロギングにそこまでコストをかけたくない(標準出力に吐くだけでいいのであれば、それに越したことはない)という気持ちが強かったので、この実験に至りました。  
こちらの記事で moga さんも同様のことを述べられています。

https://zenn.dev/moga/articles/cloudrun-structured-log

## Cloud Logging の重要度に関して

https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry?hl=ja#LogSeverity

ログをオブジェクトにして構造化し、`severity` を与えることで「重要度」をマークすることが可能です。  
`INFO`, `WARNING`, `ERROR`などを取ることが可能です。(他の値は上記サイトを確認してください。)
`severity` が与えられていないときは DEFAULT となります。

また、`severity` が与えられていないときでも、ログの内容がスタックトレース場合は、自動的に `ERROR` としてマークされます。
:::message
ちなみに私は、Error オブジェクトのログ出力には `console.error` でやることが多かったため、「重要度エラー」としてマークされる条件を、
「`stderr(標準エラー)` で出力したときは自動的に重要度がエラーになる」
と勘違いしていました。  

同じような勘違いをしている人は少ないと思いますが、`console.error` や `stderr` かどうかではなく、「`severity` の指定がなく出力内容がスタックトレースであるとき」というのが正しい条件ですので、注意喚起しておきます。
:::

この記事では Cloud Logging のスクリーンショットをそのまま載せます。重要度は次のようなアイコンで示されています。

| DEFAULT                                | INFO                                | WARNING                             | ERROR                                |
|----------------------------------------|-------------------------------------|-------------------------------------|--------------------------------------|
| ![](/images/cloud-logging-default.png) | ![](/images/cloud-logging-info.png) | ![](/images/cloud-logging-warn.png) | ![](/images/cloud-logging-error.png) |

## Error Report に関して

この記事では Cloud Logging のスクリーンショットをそのまま載せます。Error Report が生成された旨に関しては次のようなアイコンで示されています。

![](/images/error-report-icon.png)

## 実験①: console

`console.log`, `console.warn`, `console.error` を使用し、文字列と Error をそのままダイレクトに出力させました。

**結果**
```ts
console.log('error massage')              // 重要度: DEFAULT | ErrorReporting: 
console.log(new Error('error message'))   // 重要度: ERROR   | ErrorReporting: ○
console.warn('error massage')             // 重要度: DEFAULT | ErrorReporting: 
console.warn(new Error('error message'))  // 重要度: ERROR   | ErrorReporting: ○
console.error('error massage')            // 重要度: DEFAULT | ErrorReporting:
console.error(new Error('error message')) // 重要度: ERROR   | ErrorReporting: ○
// 実際の出力に使用している文字列は上記と異なるので、スクリーンショットの内容と若干異なります。
```

上記の記述順と出力順に若干のズレがあることに注意して下さい。

![](/images/gcp-logging-console.png)

Error を出力したものに関してはログレベルに関係なく、Error Report が生成されました。  
また、`severity`を設定していないので、重要度は文字列は一律でデフォルト、Error を出力したものは一律エラーとなりました。

ちなみに、こちらの記事で suin さんが、

https://qiita.com/suin/items/d5d5d7199b62eed63bde

> JavaScriptのConsole APIのメソッドの違いは、基本的にGCPの重大度に影響しません。ただし、console.warnとconsole.errorがErrorオブジェクトをロギングした場合に限り、重大度が「ERROR」になります。

と述べられていますが。2022年12月時点では、Error を出力した場合はすべて(`.log`でも)重要度は ERROR になりました。  
suin さんが記事を書かれたのが2020年8月なので、それ以降で仕様変更があったのか、あるいはCloud Runからの出力が原因なのかはわかりません。

### カスタムして重要度が変わるようにする

出力する内容を、オブジェクトの `JSON.stringify` したものにすると、Cloud Logging が構造化データとして扱います。  
`severity` に重要度のレベルが与えられていると、意図したとおりに重要度をマークすることができます。

```ts
const makeLogger = (severity: "INFO" | "WARNING" | "ERROR") => {
  return (entry: any, meta?: Record<string, any>) => {
    console.log(
      JSON.stringify({
        severity,
        message: entry instanceof Error ? entry.stack : entry,
        ...meta,
      })
    );
  };
};

const logger = {
  info: makeLogger("INFO"),
  warn: makeLogger("WARNING"),
  error: makeLogger("ERROR"),
};
```
```ts
logger.info('error massage')             // 重要度: INFO    | ErrorReporting: 
logger.info(new Error('error message'))  // 重要度: INFO    | ErrorReporting:
logger.warn('error massage')             // 重要度: WARNING | ErrorReporting: 
logger.warn(new Error('error message'))  // 重要度: WARNING | ErrorReporting:
logger.error('error massage')            // 重要度: ERROR   | ErrorReporting:
logger.error(new Error('error message')) // 重要度: ERROR   | ErrorReporting: ○
// 実際の出力に使用している文字列は上記と異なるので、スクリーンショットの内容と若干異なります。
```

![](/images/gcp-logging-console-custom.png)

`severity` が与えられたことで、loggerのログレベルと重要度が一致しました。  
また、`severity` が付与されているときに Error を出力した場合に、Error Report が生成されるのは重要度がエラー以上のものだけになります。

## 実験②: winston

## 実験③: bunyan

## 実験④: pino

## 実験⑤: loglevel

## 番外編

## まとめ