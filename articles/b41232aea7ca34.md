---
title: "Nodeã§ã®Cloud Loggingã¨Error Reportã®æœ€é©ãªä½¿ç”¨æ–¹æ³•ã‚’å®Ÿé¨“ã§å°ãå‡ºã™"
emoji: "ğŸš¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nodejs, gcp, cloudrun, logging]
published: true
---

GCP ã® Cloud Run ã§ Node ã®ã‚µãƒ¼ãƒã‚’ç¨¼åƒã•ã›ã€Cloud Logging ã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ã€æ›´ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã¨ãã¯ Error Report ã§é€šçŸ¥ã‚’å—ã‘ã‚‹ã¨ã„ã†ã‚ˆã†ãªæ§‹æˆã‚’çµ„ã‚€éš›ã«ã€
- ã©ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã€Œé‡è¦åº¦ã€ãŒæ­£ã—ããƒãƒ¼ã‚¯ã•ã‚Œã‚‹ã®ã‹
- ã©ã®ã‚ˆã†ãªå½¢å¼ã§ãƒ­ã‚°ã‚’åã‘ã° Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã®ã‹
 
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã‚‚ã€ã“ã‚Œã‚‰ã®ã“ã¨ãŒã„ã¾ã„ã¡ã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§å®Ÿé¨“ã—ã¦ã¿ã¾ã—ãŸã€‚  

ã¾ãŸã€æ¨™æº–ã® console ã ã‘ã§ã¯ãªãã€Node ã®ä¸»è¦ãªãƒ­ã‚¬ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ã†ã¡ã€ã©ã‚ŒãŒä¸€ç•ª Cloud Logging ã¨ Error Report ã¨ã®ç›¸æ€§ãŒè‰¯ã„ã®ã‹ã‚‚å®Ÿé¨“ã‹ã‚‰å°ãå‡ºã—ã¾ã—ãŸã€‚

## å‰æ

### ãƒ­ã‚®ãƒ³ã‚°æ–¹æ³•

Cloud Run ã§ express ã‚µãƒ¼ãƒã‚’ç”¨æ„ã—ã€ä¸‹è¨˜ã®ã‚ˆã†ã«æ–‡å­—åˆ—ã¨ Error ã‚’ãƒ­ã‚¬ãƒ¼ã§æ¨™æº–å‡ºåŠ›ãŠã‚ˆã³æ¨™æº–ã‚¨ãƒ©ãƒ¼ã«å‡ºåŠ›

```ts
app.get("/", (req, res) => {
  logger.info('error massage')            
  logger.info(new Error('error message'))
  logger.warn('error massage')            
  logger.warn(new Error('error message'))
  logger.error('error massage')          
  logger.error(new Error('error message'))

  res.send();
});
```

### ä½¿ç”¨ãƒ­ã‚¬ãƒ¼

- console
- [winston](https://github.com/winstonjs/winston)
- [bunyan](https://github.com/trentm/node-bunyan)
- [pino](https://github.com/pinojs/pino)
- [loglevel](https://github.com/pimterry/loglevel)

[npmlog](https://github.com/npm/npmlog) ã¯ãƒ­ã‚¬ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã§ä¸€ç•ªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°ãŒå¤šã„æœ‰åãªãƒ­ã‚¬ãƒ¼ã ãŒã€Error ã‚’å‡ºåŠ›ã™ã‚‹ã®ã«ã¯ã‚ã¾ã‚Šå‘ã„ã¦ã„ãªã„ãŸã‚æœ¬èª¿æŸ»ã§ã¯å¯¾è±¡å¤–ã¨ã™ã‚‹ã€‚

### èª¿æŸ»è¦³ç‚¹

- Cloud Logging ã®ã€Œé‡è¦åº¦ã€ãŒã©ã†ãªã‚‹ã‹
- Error Report ãŒç”Ÿæˆã•ã‚Œã‚‹ã‹ã©ã†ã‹

### ãã‚‚ãã‚‚...

[@google-cloud/logging](https://github.com/googleapis/nodejs-logging) ã‚’åˆ©ç”¨ã—ãŸã‚Šã€ã‚ã‚‹ã„ã¯ã€GCP ãŒå…¬å¼ã«ç”¨æ„ã—ã¦ã„ã‚‹ winston ã‚„ bunyan ç”¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç”¨ã„ã‚Œã°ã€Logging ã¨ Reporting ã¯ãã‚ç´°ã‹ãè¨­å®šå¯èƒ½ã§ã™ã€‚  

https://cloud.google.com/logging/docs/setup/nodejs?hl=ja

ã—ã‹ã—å†…éƒ¨çš„ã«ã¯ GRPC ã§ã®é€šä¿¡ã‚’ç™ºç”Ÿã•ã›ã¦ API ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ã®ã§ã€ãƒ­ã‚®ãƒ³ã‚°ã«ãã“ã¾ã§ã‚³ã‚¹ãƒˆã‚’ã‹ã‘ãŸããªã„(æ¨™æº–å‡ºåŠ›ã«åãã ã‘ã§ã„ã„ã®ã§ã‚ã‚Œã°ã€ãã‚Œã«è¶Šã—ãŸã“ã¨ã¯ãªã„)ã¨ã„ã†æ°—æŒã¡ãŒå¼·ã‹ã£ãŸã®ã§ã€ã“ã®å®Ÿé¨“ã«è‡³ã‚Šã¾ã—ãŸã€‚  

ã“ã¡ã‚‰ã®è¨˜äº‹ã§ moga ã•ã‚“ã‚‚åŒæ§˜ã®ã“ã¨ã‚’è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

https://zenn.dev/moga/articles/cloudrun-structured-log

## ä»•æ§˜ã«é–¢ã™ã‚‹è£œè¶³

### Cloud Logging ã®é‡è¦åº¦ã«é–¢ã—ã¦

https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry?hl=ja#LogSeverity

ãƒ­ã‚°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã—ã¦æ§‹é€ åŒ–ã—ã€`severity` ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã€Œé‡è¦åº¦ã€ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  
`INFO`, `WARNING`, `ERROR`ãªã©ã‚’å–ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚(ä»–ã®å€¤ã¯ä¸Šè¨˜ã‚µã‚¤ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚)
`severity` ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„ã¨ãã¯ DEFAULT ã¨ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€`severity` ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„ã¨ãã§ã‚‚ã€ãƒ­ã‚°ã®å†…å®¹ãŒã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹å ´åˆã¯ã€è‡ªå‹•çš„ã« `ERROR` ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã¾ã™ã€‚
:::message
å€‹äººçš„ã« Error ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°å‡ºåŠ›ã¯ `console.error` ã§ã‚„ã‚‹ã“ã¨ãŒå¤šã‹ã£ãŸãŸã‚ã€é‡è¦åº¦ãŒã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã‚‹æ¡ä»¶ã‚’ã€
ã€Œ`stderr (æ¨™æº–ã‚¨ãƒ©ãƒ¼)`ã§å‡ºåŠ›ã—ãŸã¨ãã¯è‡ªå‹•çš„ã«é‡è¦åº¦ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€
ã¨å‹˜é•ã„ã—ã¦ã„ã¾ã—ãŸã€‚  

åŒã˜ã‚ˆã†ãªå‹˜é•ã„ã‚’ã—ã¦ã„ã‚‹äººã¯å¤šããªã„ã¨æ€ã„ã¾ã™ãŒã€`console.error` ã‚„ `stderr` ã‹ã©ã†ã‹ã§ã¯ãªãã€ã€Œ`severity` ã®æŒ‡å®šãŒãªãå‡ºåŠ›å†…å®¹ãŒã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã‚ã‚‹ã¨ãã€ã¨ã„ã†ã®ãŒæ­£ã—ã„æ¡ä»¶ã§ã™ã®ã§ã€æ³¨æ„å–šèµ·ã—ã¦ãŠãã¾ã™ã€‚
:::

ã“ã®è¨˜äº‹ã§ã¯ Cloud Logging ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãã®ã¾ã¾è¼‰ã›ã¾ã™ã€‚é‡è¦åº¦ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ã‚¤ã‚³ãƒ³ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

| DEFAULT                                | INFO                                | WARNING                             | ERROR                                |
|----------------------------------------|-------------------------------------|-------------------------------------|--------------------------------------|
| ![](/images/cloud-logging-default.png) | ![](/images/cloud-logging-info.png) | ![](/images/cloud-logging-warn.png) | ![](/images/cloud-logging-error.png) |

### Cloud Logging ã‹ã‚‰ Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹æ¡ä»¶

https://cloud.google.com/error-reporting/docs/formatting-error-messages?hl=ja

**ã‚¹ã‚¿ãƒƒã‚¯ ãƒˆãƒ¬ãƒ¼ã‚¹ã¾ãŸã¯ä¾‹å¤–ã‚’å«ã‚€ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª**

ã“ã®æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‹ã®ã¯ä¸‹è¨˜ã®ã©ã¡ã‚‰ã‹

- ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§Error.prototype.stackã‚’å‡ºåŠ›
- ä¸‹è¨˜å½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿

```ts
{
  "err": {
    "message": string,
    "name": string,
    "stack": string
  }
}
```

:::message
`severity` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ãã¯ `ERROR` (é‡è¦åº¦:ã‚¨ãƒ©ãƒ¼)ã®ã¨ãã®ã¿ Error Report ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
:::

**ReportedErrorEvent ã®ã‚ˆã†ãªå½¢å¼ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª**

- å½¢å¼ã¯ä¸‹è¨˜ã®é€šã‚Š

```json
{
  "@type": "type.googleapis.com/google.devtools.clouderrorreporting.v1beta1.ReportedErrorEvent",
  "message": "A simple text message"
}
```

ã“ã¡ã‚‰ã¯ `severity` ã®æœ‰ç„¡ã«ã‚ˆã‚‰ãšã€ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã§ Error Report ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ãŸã ã—ã€ã“ã®æ–¹æ³•ã ã¨ç™ºç”Ÿå ´æ‰€ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚æ³¨æ„ã§ã™ã€‚ä¾‹å¤–ä»¥å¤–ã®ã‚‚ã®(ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãªã©)ã‚’ Error Report ã«æ®‹ã—ãŸã„å ´åˆã¯ã“ã‚Œã‚’ä½¿ã†ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

ã“ã®è¨˜äº‹ã§ã¯ Cloud Logging ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãã®ã¾ã¾è¼‰ã›ã¾ã™ã€‚Error Report ãŒç”Ÿæˆã•ã‚ŒãŸæ—¨ã«é–¢ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ã‚¤ã‚³ãƒ³ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/error-report-icon.png)

## å®Ÿé¨“â‘ : console

`console.log`, `console.warn`, `console.error` ã‚’ä½¿ç”¨ã—ã€æ–‡å­—åˆ—ã¨ Error ã‚’ãã®ã¾ã¾ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å‡ºåŠ›ã•ã›ã¾ã—ãŸã€‚

```ts
console.log('error massage')              // é‡è¦åº¦: DEFAULT | ErrorReport:
console.log(new Error('error message'))   // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
console.warn('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport:
console.warn(new Error('error message'))  // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
console.error('error massage')            // é‡è¦åº¦: DEFAULT | ErrorReport:
console.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

ä¸Šè¨˜ã®è¨˜è¿°é †ã¨å‡ºåŠ›é †ã«è‹¥å¹²ã®ã‚ºãƒ¬ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ä¸‹ã•ã„ã€‚

![](/images/gcp-logging-console.png)

Error ã‚’å‡ºåŠ›ã—ãŸã‚‚ã®ã«é–¢ã—ã¦ã¯ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«é–¢ä¿‚ãªãã€Error Report ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚  
ã¾ãŸã€`severity` ã‚’è¨­å®šã—ã¦ã„ãªã„ã®ã§ã€é‡è¦åº¦ã¯æ–‡å­—åˆ—ã¯ä¸€å¾‹ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€Error ã‚’å‡ºåŠ›ã—ãŸã‚‚ã®ã¯ä¸€å¾‹ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã—ãŸã€‚

### è£œè¶³

ã¡ãªã¿ã«ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã§ suin ã•ã‚“ãŒã€

https://qiita.com/suin/items/d5d5d7199b62eed63bde

> JavaScriptã®Console APIã®ãƒ¡ã‚½ãƒƒãƒ‰ã®é•ã„ã¯ã€åŸºæœ¬çš„ã«GCPã®é‡å¤§åº¦ã«å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ãŸã ã—ã€console.warnã¨console.errorãŒErrorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ã‚®ãƒ³ã‚°ã—ãŸå ´åˆã«é™ã‚Šã€é‡å¤§åº¦ãŒã€ŒERRORã€ã«ãªã‚Šã¾ã™ã€‚

ã¨è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€‚2022å¹´12æœˆæ™‚ç‚¹ã§ã¯ã€Error ã‚’å‡ºåŠ›ã—ãŸå ´åˆã¯ã™ã¹ã¦(`.log`ã§ã‚‚)é‡è¦åº¦ã¯ ERROR ã«ãªã‚Šã¾ã—ãŸã€‚  
suin ã•ã‚“ãŒè¨˜äº‹ã‚’æ›¸ã‹ã‚ŒãŸã®ãŒ2020å¹´8æœˆãªã®ã§ã€ãã‚Œä»¥é™ã§ä»•æ§˜å¤‰æ›´ãŒã‚ã£ãŸã®ã‹ã€ã‚ã‚‹ã„ã¯Cloud Runã‹ã‚‰ã®å‡ºåŠ›ãŒåŸå› ãªã®ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚

### ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¬ãƒ¼ã‚’ä½œã‚‹

å‡ºåŠ›ã™ã‚‹å†…å®¹ã‚’ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® `JSON.stringify` ã—ãŸã‚‚ã®ã«ã™ã‚‹ã¨ã€Cloud Logging ãŒæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚  
`severity` ã«é‡è¦åº¦ã®ãƒ¬ãƒ™ãƒ«ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹ã¨ã€æ„å›³ã—ãŸã¨ãŠã‚Šã«é‡è¦åº¦ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const makeLogger = (severity: "INFO" | "WARNING" | "ERROR") => {
  return (entry: any, meta?: Record<string, any>) => {
    console.log(
      JSON.stringify({
        severity,
        message: entry instanceof Error ? entry.stack : entry,
        ...meta,
      })
    );
  };
};

const logger = {
  info: makeLogger("INFO"),
  warn: makeLogger("WARNING"),
  error: makeLogger("ERROR"),
};
```
```ts
logger.info('error massage')             // é‡è¦åº¦: INFO    | ErrorReport:
logger.info(new Error('error message'))  // é‡è¦åº¦: INFO    | ErrorReport:
logger.warn('error massage')             // é‡è¦åº¦: WARNING | ErrorReport:
logger.warn(new Error('error message'))  // é‡è¦åº¦: WARNING | ErrorReport:
logger.error('error massage')            // é‡è¦åº¦: ERROR   | ErrorReport:
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

![](/images/gcp-logging-console-custom.png)

`severity` ãŒä¸ãˆã‚‰ã‚ŒãŸã“ã¨ã§ã€loggerã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¨é‡è¦åº¦ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚  
ã¾ãŸã€`severity` ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã¨ãã« Error ã‚’å‡ºåŠ›ã—ãŸå ´åˆã«ã€Error Report ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã¯é‡è¦åº¦ãŒã‚¨ãƒ©ãƒ¼ä»¥ä¸Šã®ã‚‚ã®ã ã‘ã«ãªã‚Šã¾ã™ã€‚

## å®Ÿé¨“â‘¡: winston

https://github.com/winstonjs/winston

```ts
const logger = winston.createLogger({
  level: "info",
  format: winston.format.combine(
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [new winston.transports.Console()],
});
```

```ts
logger.info('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport: 
logger.info(new Error('error message'))  // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.warn('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport: 
logger.warn(new Error('error message'))  // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.error('error massage')            // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.error(new Error('error message')) // é‡è¦åº¦: DEFAULT | ErrorReport:
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

![](/images/gcp-logging-winston.png)

winston ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ­ã‚°è‡ªä½“ã¯æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«ãªã£ã¦ã„ã¾ã™ãŒã€`severity` ãŒä»˜ä¸ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€é‡è¦åº¦ã¯ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚Šã¾ã™ã€‚
ã¾ãŸã€winston ã®æ¨™æº–ã®ã‚¨ãƒ©ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ `winston.format.errors({ stack: true })` ã¯ Error ã‚’æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã§åãå‡ºã—ã¦ãŠã‚Šã€ã“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã¯ Error Report ã¯ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã€‚
```
{
  "message": "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
  "stack": "ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹"
}
```

ã‚ˆã£ã¦ã€winston ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã›ãšã«ãƒ—ãƒ¼ãƒ¬ãƒ³ã«ä½¿ã†çŠ¶æ…‹ã§ã¯ã€Cloud Logging ãŠã‚ˆã³ Error Report ã¨ã®ç›¸æ€§ã¯ã‚ˆããªã„ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚

### winston ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒ ã—ã¦ä½¿ç”¨ã™ã‚‹

ãƒ—ãƒ¬ãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ã¯ã€ã‚ã¾ã‚Šç›¸æ€§ã¯ã‚ˆãã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’å®šç¾©ã—ã¦ã‚ã’ã‚Œã°ã€é‡è¦åº¦ã®è¨­å®šã¨ Error Report ã®è‡ªå‹•ç”ŸæˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```ts
const severity = winston.format((info) => {
  info["severity"] = info.level.toUpperCase();
  return info;
});

const errorReport = winston.format((info) => {
  if (info instanceof Error) {
    info.err = {
      name: info.name,
      message: info.message,
      stack: info.stack,
    };
  }
  return info;
});

const logger = winston.createLogger({
  level: "info",
  format: winston.format.combine(
    severity(),
    errorReport(),
    winston.format.json()
  ),
  transports: [new winston.transports.Console()],
});
```

```ts
logger.info('error massage')             // é‡è¦åº¦: INFO    | ErrorReport:
logger.info(new Error('error message'))  // é‡è¦åº¦: INFO    | ErrorReport:
logger.warn('error massage')             // é‡è¦åº¦: WARNING | ErrorReport:
logger.warn(new Error('error message'))  // é‡è¦åº¦: WARNING | ErrorReport:
logger.error('error massage')            // é‡è¦åº¦: ERROR   | ErrorReport:
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ… 
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

![](/images/gcp-logging-winston-custom.png)

ãƒ­ã‚°ã«ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã¯å‰è¿°ã—ãŸã¨ãŠã‚Šã§ã™ãŒã€æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã‚‚ Error Report ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```
{
  "err": {
    "message": string,
    "name": string,
    "stack": string
  }
}
```
winston ãã®ã‚‚ã®ã¯ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ã®ã§ã€ã“ã®æ§‹é€ ã®ãƒ‡ãƒ¼ã‚¿ã‚’åãå‡ºã™ã‚ˆã†ã«ã™ã‚‹ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

## å®Ÿé¨“â‘¢: bunyan

https://github.com/trentm/node-bunyan

```ts
const logger = bunyan.createLogger({
  name: "cloud-logging-test",
  level: "info",
});
```
```ts
logger.info('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.info(new Error('error message'))  // é‡è¦åº¦: DEFAULT | ErrorReport: âœ…
logger.warn('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.warn(new Error('error message'))  // é‡è¦åº¦: DEFAULT | ErrorReport: âœ…
logger.error('error massage')            // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.error(new Error('error message')) // é‡è¦åº¦: DEFAULT | ErrorReport: âœ…
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```
![](/images/gcp-logging-bunyan.png)

`severity` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã®ã§ã€é‡è¦åº¦ã¯ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚Šã¾ã™ã€‚  
Error ã‚’å¼•æ•°ã«æ¸¡ã—ãŸã¨ãã®ãƒ­ã‚°ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ `{ err: { ... } }` ã®å½¢å¼ã§å‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ bunyan ã‚’åˆ©ç”¨ã—ã¦ã‚‚ Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚  
ã¾ãŸã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡ºåŠ›ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€é‡è¦åº¦ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã™ã€‚ãã®ç‚¹ã§è‹¥å¹² console ã¨ç•°ãªã‚Šã¾ã™ã€‚

bunyan ã¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã‚„ã‚Šã«ãã„ã®ã§ã€é‡è¦åº¦ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚  
(stream ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã†ã¾ãè¨­å®šã™ã‚Œã°ã§ãã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã‚ãã‚‰ã‚ã¾ã—ãŸã€‚)

Cloud Logging ã®é‡è¦åº¦ã‚’ç‰¹ã«æ°—ã«ã›ãšã€ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸã¨ãã« Error Report ã‚’ç”Ÿæˆã™ã‚‹ã ã‘ã§ã‚ˆã„ã®ã§ã‚ã‚Œã°ã€bunyan ã§ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ãŸã ã€console ã¨ã»ã¼åŒã˜çµæœã«ãªã‚‹ã®ã§ã€Cloud Logging ã¨ Error Report ã®è¦³ç‚¹ã ã‘ã§è¦‹ã‚‹ã¨ã€console ã‚’ä½¿ã‚ãšã«ã€ã‚ãˆã¦ bunyan ã‚’é¸æŠã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆã¯è–„ã„ã§ã—ã‚‡ã†ã€‚

## å®Ÿé¨“â‘£: pino

https://github.com/pinojs/pino

```ts
const logger = pino({
  level: "info",
});
```
```ts
logger.info('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.info(new Error('error message'))  // é‡è¦åº¦: DEFAULT | ErrorReport: âœ…
logger.warn('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.warn(new Error('error message'))  // é‡è¦åº¦: DEFAULT | ErrorReport: âœ…
logger.error('error massage')            // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.error(new Error('error message')) // é‡è¦åº¦: DEFAULT | ErrorReport: âœ…
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```
![](/images/gcp-logging-pino.png)

`severity` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã®ã§ã€é‡è¦åº¦ã¯ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚Šã¾ã™ã€‚  
Error ã‚’å¼•æ•°ã«æ¸¡ã—ãŸã¨ãã®ãƒ­ã‚°ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ `{ err: { ... } }` ã®å½¢å¼ã§å‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ pino ã‚’åˆ©ç”¨ã—ã¦ã‚‚ Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ã¾ãŸã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡ºåŠ›ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€é‡è¦åº¦ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã™ã€‚çµæœçš„ã«ã¯ bunyan ã¨å…¨ãåŒã˜ã«ãªã‚Šã¾ã—ãŸã€‚

### pino ã‚’ã‚«ã‚¹ã‚¿ãƒ ã—ã¦é‡è¦åº¦ã‚’æœ€é©åŒ–ã™ã‚‹

`mixin` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ç°¡å˜ã« `severity` ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const labels = pino().levels.labels;
const logger = pino({
  level: "info",
  mixin: (_, level) => {
    return { severity: labels[level].toUpperCase() };
  },
});
```
```ts
logger.info('error massage')             // é‡è¦åº¦: INFO    | ErrorReport: 
logger.info(new Error('error message'))  // é‡è¦åº¦: INFO    | ErrorReport:
logger.warn('error massage')             // é‡è¦åº¦: WARNING | ErrorReport: 
logger.warn(new Error('error message'))  // é‡è¦åº¦: WARNING | ErrorReport:
logger.error('error massage')            // é‡è¦åº¦: ERROR   | ErrorReport: 
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ… 
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```
![](/images/gcp-logging-pino-custom.png)

å†ä¸‰ã®èª¬æ˜ã«ãªã‚Šã¾ã™ãŒã€`severity` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ãã¯ã€Error Report ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã¯ã€é‡è¦åº¦ãŒã‚¨ãƒ©ãƒ¼ã®ã¨ãã®ã¿ã§ã™ã€‚

ä»Šå›ã®å„å®Ÿé¨“ã®ä¸­ã§ã¯ã€ä¸€ç•ªè¨˜è¿°é‡å°‘ãªãé‡è¦åº¦ã®æœ€é©åŒ–ãŒã§ãã‚‹ã®ã§ã€pino ã‚’ä½¿ç”¨ã—ã¦ `mixin` ã‚’è¨­å®šã™ã‚‹ã“ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒä¸€ç•ªãŠã™ã™ã‚ã§ã™ã€‚

## å®Ÿé¨“â‘¤: loglevel

https://github.com/pimterry/loglevel

```ts
loglevel.setLevel('info')
const logger = loglevel;
```
```ts
logger.log('error massage')              // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.log(new Error('error message'))   // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
logger.warn('error massage')             // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.warn(new Error('error message'))  // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
logger.error('error massage')            // é‡è¦åº¦: DEFAULT | ErrorReport:
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

ä¸Šè¨˜ã®è¨˜è¿°é †ã¨å‡ºåŠ›é †ã«è‹¥å¹²ã®ã‚ºãƒ¬ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ä¸‹ã•ã„ã€‚

![](/images/gcp-logging-loglevel.png)

Error ã‚’å‡ºåŠ›ã—ãŸã‚‚ã®ã«é–¢ã—ã¦ã¯ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«é–¢ä¿‚ãªãã€Error Report ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚  
ã¾ãŸã€`severity` ã‚’è¨­å®šã—ã¦ãŠã‚‰ãšã€ã‹ã¤ Error ã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒãƒ–ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€å¼•æ•°ã« Error ã‚’æ¸¡ã—ãŸã‚‚ã®ã¯è‡ªå‹•çš„ã«é‡è¦åº¦ãŒ ERROR ã¨ãªã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€console ã¨å…¨ãåŒã˜çµæœã¨ãªã‚Šã¾ã—ãŸã€‚

loglevel ã¯ãƒ­ã‚°ã‚’æ§‹é€ åŒ–ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å¤‰æ›´ãŒè¡Œãˆãªã‹ã£ãŸã®ã§ã€`severity` ã‚’ä»˜ä¸ã—ã¦é‡è¦åº¦ã‚’æœ€é©åŒ–ã™ã‚‹ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚

console ã¨å…¨ãåŒã˜çµæœã«ãªã‚Šã€ã¾ãŸã€é‡è¦åº¦ã®æœ€é©åŒ–ã‚‚è¡Œã„ã«ãã„ã®ã§ã€Cloud Logging ã¨ Error Report ã®è¦³ç‚¹ã ã‘ã§è¦‹ã‚‹ã¨ console ã‚’ä½¿ã‚ãšã«ã‚ãˆã¦ loglevel ã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã¯è–„ã„ã§ã—ã‚‡ã†ã€‚

## ç•ªå¤–ç·¨

å€‹äººçš„ã«ã¯ã€ä¾‹å¤–ã‚’å‡ºåŠ›ã—ãŸã¨ãã ã‘ã§ãªãã€æ–‡å­—åˆ—ã‚„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ `logger.error()` ã§å‡ºåŠ›ã—ãŸã¨ãã‚‚ Error Report ãŒç”Ÿæˆã•ã‚Œã‚‹ã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚  
3rd ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã£ã¦ã¯ã€å‡¦ç†ä¸­ã«ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã›ãšã€ç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¿”å´ã™ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€ãã†ã„ã£ãŸã‚‚ã®ã‚’æ‰‹å‹•ã§ Error Report ã«æ®‹ã›ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚

è¦ã™ã‚‹ã«ã“ã†ã„ã†ã“ã¨ã§ã™ã€‚(`logger.error` ã‚’ä½¿ç”¨ã—ãŸå ´åˆã€å¼•æ•°ã«ã‚ˆã‚‰ãš Error Report ãŒç”Ÿæˆã•ã‚Œã¦ã»ã—ã„)
```ts
logger.info('error massage')             // é‡è¦åº¦: INFO    | ErrorReport: 
logger.info(new Error('error message'))  // é‡è¦åº¦: INFO    | ErrorReport:
logger.warn('error massage')             // é‡è¦åº¦: WARNING | ErrorReport: 
logger.warn(new Error('error message'))  // é‡è¦åº¦: WARNING | ErrorReport:
logger.error('error massage')            // é‡è¦åº¦: ERROR   | ErrorReport: âœ… 
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
```

ã“ã®è¦ä»¶ã‚’æº€ãŸã™ã‚ˆã†ã«ãƒ­ã‚¬ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã«ã¯ã€å…ˆã®ã€ŒCloud Logging ã‹ã‚‰ Error Report ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹æ¡ä»¶ã€ã®é …ã§è¨˜è¿°ã—ãŸã¨ãŠã‚Šã€ã“ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã«ãªã£ã¦ã„ã‚Œã°è‰¯ã•ãã†ã§ã™ã€‚
```json
{
  "@type": "type.googleapis.com/google.devtools.clouderrorreporting.v1beta1.ReportedErrorEvent",
  "message": "A simple text message"
}
```

:::message
ãŸã ã—ã€ã“ã¡ã‚‰ã®å½¢å¼ã§ã¯ã€ç™ºç”Ÿç®‡æ‰€ç­‰ã®ãƒ¡ã‚¿æƒ…å ±ã®ãƒãƒ¼ã‚­ãƒ³ã‚°ãŒã§ããªã„ã®ã§æ³¨æ„ã§ã™ã€‚
ã“ã‚“ãªæ„Ÿã˜ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ã¯ç©ºã«ãªã‚Šã¾ã™ã€‚
![](/images/error-report-blank.png)

ä¸å¯§ã«è¨˜éŒ²ã—ãŸã„ã®ã§ã‚ã‚Œã°ã€æ½”ã[@google-cloud/logging](https://github.com/googleapis/nodejs-logging)ã‚’åˆ©ç”¨ã—ã¾ã—ã‚‡ã†ã€‚
:::

### winston ã§å®Ÿç¾ã™ã‚‹

console.log ä»¥å¤–ã§ä¸€ç•ªç°¡å˜ã«ã‚«ã‚¹ã‚¿ãƒ ã§ããŸã®ã¯ã€winston ã§ã—ãŸã€‚

```ts
const severity = winston.format((info) => {
  info["severity"] = info.level.toUpperCase();
  return info;
});

const errorReport = winston.format((info) => {
  if (info instanceof Error) {
    info.err = {
      name: info.name,
      message: info.message,
      stack: info.stack,
    };
  } else if (info.level === "error") {
    info["@type"] =
            "type.googleapis.com/google.devtools.clouderrorreporting.v1beta1.ReportedErrorEvent";
  }
  return info;
});

export const logger = winston.createLogger({
  level: "info",
  format: winston.format.combine(
    severity(),
    errorReport(),
    winston.format.json()
  ),
  transports: [new winston.transports.Console()],
});
```
```ts
logger.info('error massage')             // é‡è¦åº¦: INFO    | ErrorReport: 
logger.info(new Error('error message'))  // é‡è¦åº¦: INFO    | ErrorReport:
logger.warn('error massage')             // é‡è¦åº¦: WARNING | ErrorReport: 
logger.warn(new Error('error message'))  // é‡è¦åº¦: WARNING | ErrorReport:
logger.error('error massage')            // é‡è¦åº¦: ERROR   | ErrorReport: âœ… 
logger.error(new Error('error message')) // é‡è¦åº¦: ERROR   | ErrorReport: âœ…
// å®Ÿéš›ã®å‡ºåŠ›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã¯ä¸Šè¨˜ã¨ç•°ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å†…å®¹ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚
```

![](/images/gcp-logging-winston-custom2.png)

### pino ã¯ã†ã¾ãã§ããªã‹ã£ãŸ

pino ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¼ãŒ `msg` ã¨ãªã£ã¦ãŠã‚Šã€`messageKey: 'message'` ã¨ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
ãŸã ã€ãã†ã™ã‚‹ã¨ä¾‹å¤–ã‚’å‡¦ç†ã™ã‚‹å ´åˆã« `err` ã¨ `message` ãŒç«¶åˆã—ã¦ã—ã¾ã†ãŸã‚ã«ã€Error Report ã¯ç”Ÿæˆã•ã‚Œã‚Œã‚‹ã‚‚ã®ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œãªããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
transport api ãªã©ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ç«¶åˆã—ãªã„ã‚ˆã†ã«ã§ãã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä¸€æ—¦ã“ã‚Œä»¥ä¸Šã®è¿½æ±‚ã¯ã‚„ã‚ã¦ãŠãã¾ã™ã€‚

```ts
const logger = pino({
  level: "info",
  messageKey: "message",
  mixin: (context, level) => {
    if (labels[level] === "error")
      return {
        severity: labels[level].toUpperCase(),
        "@type":
          "type.googleapis.com/google.devtools.clouderrorreporting.v1beta1.ReportedErrorEvent",
      };
    return { severity: labels[level].toUpperCase() };
  },
});
```

å‡ºåŠ›çµæœ (`err` ã‚ˆã‚Šã‚‚ã€`message` ãŒå„ªå…ˆã•ã‚Œã¦ Error Report ãŒç”Ÿæˆã•ã‚Œã¦ã—ã¾ã†ã®ã§ã†ã¾ãã„ã‹ãªã„)
```
{
  "err": {
    "message": "..."
    "name": "..."
    "stack": "..."
  },
  "message": "err.messageã¨åŒã˜ã‚‚ã®ãŒå…¥ã‚‹",
  "@type": "type.googleapis.com/google.devtools.clouderrorreporting.v1beta1.ReportedErrorEvent"
}
```

## ã¾ã¨ã‚

å®Ÿé¨“ã®çµæœã‚’ç°¡å˜ã«ã¾ã¨ã‚ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚ã‚«ãƒãƒ¼ã—ãŸã„è¦ä»¶ã«å¿œã˜ã¦ã€æœ€é©ãªãƒ­ã‚¬ãƒ¼ãŒå¤‰ã‚ã£ã¦ãã¾ã™ã€‚

- é‡è¦åº¦ã®æœ€é©åŒ–ã¯ã›ãšã€ä¸€æ—¦ã€Error å‡ºåŠ›æ™‚ã« Error Report ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚Œã°ã‚ˆã„ã®ã§ã‚ã‚Œã° **console**
    - winson ä»¥å¤– (bunyan, pino, loglevel) ãªã‚‰ã€ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¦ä»¶ã‚’æº€ãŸã›ã‚‹ãŒã€ã“ã®æ¡ä»¶ãªã‚‰ã€ã‚ã–ã‚ã– 3rd ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãªãƒ­ã‚¬ãƒ¼ã‚’å…¥ã‚Œã‚‹å¿…è¦ã¯ãªã„
- é‡è¦åº¦ã®æœ€é©åŒ–ã¨ Error å‡ºåŠ›æ™‚ã® Error Report ç”Ÿæˆã®ä¸¡æ–¹ã‚’å–ã‚‹ã®å‡ºã‚Œã° **pino**
    - console, winston ã§ã‚‚å®Ÿç¾ã§ãã‚‹ãŒã€pino ãŒä¸€ç•ªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®è¨˜è¿°é‡ãŒå°‘ãªãæ¸ˆã‚€
- Error ã ã‘ã§ãªãæ–‡å­—åˆ—(ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)ã§ã‚‚ Error Report ã‚’ç”Ÿæˆã—ãŸã„ã®ã§ã‚ã‚Œã° **console** or **winston**
    - ã©ã¡ã‚‰ã«ã—ã¦ã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯å¿…è¦
